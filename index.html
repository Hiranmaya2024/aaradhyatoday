<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f1f5f9}
.panel{padding:12px;background:#fff}
#map{height:60vh}
button,select{width:100%;padding:14px;margin-top:8px;border-radius:10px;border:none;font-weight:bold}
.mainBtn{background:#16a34a;color:#fff}
</style>
</head>

<body>

<div class="panel" id="panel"></div>
<div id="map"></div>

<script>

const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
MONDAY:["JURIA"],
TUESDAY:["GHESS"],
WEDNESDAY:["GAISILATE"],
THURSDAY:["JHARBANDH"],
FRIDAY:["PADAMPUR"],
SATURDAY:["PAIKMAL","MANDOSIL"]
};

let map=L.map('map').setView([20.9,83.4],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let liveLat=20.9, liveLng=83.4;
let routeStartLat, routeStartLng;

let data=[], today=[];
let visitedIds=new Set();
let currentId=null;

let routeLine, userMarker, partyMarkers=[];

const num=v=>Number(String(v||"").replace(/[^0-9.-]/g,""))||0;

navigator.geolocation.watchPosition(pos=>{
liveLat=pos.coords.latitude;
liveLng=pos.coords.longitude;

if(userMarker) map.removeLayer(userMarker);
userMarker=L.circleMarker([liveLat,liveLng],{radius:8,color:"blue",fillColor:"blue",fillOpacity:1}).addTo(map);
});

async function loadCSV(){
const res=await fetch(CSV_URL);
const text=await res.text();
const parsed=Papa.parse(text,{header:true});

data=parsed.data.map((r,i)=>({
id:i,
party:r.PARTY,
area:(r.AREA||"").toUpperCase(),
lat:num(r.LAT),
lng:num(r.LNG)
})).filter(x=>x.party);

renderDay("MONDAY");
}

function setPanel(html){
panel.innerHTML=`<select onchange="renderDay(this.value)">
${Object.keys(tourPlan).map(d=>`<option>${d}</option>`)}
</select>`+html;
}

function renderDay(day){
today=data.filter(d=>tourPlan[day].some(a=>d.area.includes(a)));
visitedIds.clear();
currentId=null;
drawPins();
setPanel(`<b>${day}</b><br>üè™ ${today.length}
<button class="mainBtn" onclick="startTour()">START TOUR</button>`);
}

function drawPins(){

partyMarkers.forEach(m=>map.removeLayer(m));
partyMarkers=[];

today.forEach(p=>{
let color="gray";
if(visitedIds.has(p.id)) color="green";
if(currentId===p.id) color="orange";

partyMarkers.push(
L.circleMarker([p.lat,p.lng],{
radius:7,color:color,fillColor:color,fillOpacity:1
}).addTo(map)
);
});
}

function distance(a,b,c,d){
const R=6371;
const dLat=(c-a)*Math.PI/180;
const dLon=(d-b)*Math.PI/180;
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

function buildRoute(){

let pending=today.filter(p=>!visitedIds.has(p.id));

let lat=liveLat, lng=liveLng;
let coords=[[lat,lng]];

let temp=[...pending];

while(temp.length){
temp.forEach(p=>p.d=distance(lat,lng,p.lat,p.lng));
temp.sort((a,b)=>a.d-b.d);
let next=temp.shift();
coords.push([next.lat,next.lng]);
lat=next.lat;
lng=next.lng;
}

return coords;
}

function drawRoute(){

if(routeLine) map.removeLayer(routeLine);

let coords=buildRoute();

routeLine=L.polyline(coords,{color:"blue",weight:4}).addTo(map);
map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
}

function startTour(){
routeStartLat=liveLat;
routeStartLng=liveLng;
goNext();
}

function goNext(){

let pending=today.filter(p=>!visitedIds.has(p.id));

if(!pending.length){
returnToStart();
return;
}

pending.forEach(p=>p.d=distance(liveLat,liveLng,p.lat,p.lng));
pending.sort((a,b)=>a.d-b.d);

currentId=pending[0].id;

drawPins();
drawRoute();

setPanel(`<b>${pending[0].party}</b>
<br>üìç ${pending[0].d.toFixed(2)} km
<button class="mainBtn" onclick="completeVisit()">COMPLETE VISIT</button>`);
}

function completeVisit(){
visitedIds.add(currentId);
currentId=null;
goNext();
}

function returnToStart(){

if(routeLine) map.removeLayer(routeLine);

routeLine=L.polyline([
[liveLat,liveLng],
[routeStartLat,routeStartLng]
],{color:"red",dashArray:"6,6",weight:4}).addTo(map);

map.fitBounds(routeLine.getBounds(),{padding:[40,40]});

setPanel("<b>Route Completed</b>");
}

loadCSV();

</script>
</body>
</html>