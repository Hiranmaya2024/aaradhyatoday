<script>

const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
Monday:["Juria"],
Tuesday:["Ghess"],
Wednesday:["Gaisilate"],
Thursday:["Jharbandh"],
Friday:["Padampur"],
Saturday:["Paikmal","Mandosil"]
};

function cleanNumber(val){
return Number(String(val||0).replace(/[^0-9.-]/g,""))||0;
}

function loadData(){

const today=new Date().toLocaleDateString("en-US",{weekday:"long"});
const todayAreas=tourPlan[today]||[];

document.getElementById("tourArea").innerText=
today+" Tour â†’ "+todayAreas.join(", ");

Papa.parse(sheetURL,{
download:true,
header:true,
skipEmptyLines:true,

complete:function(res){

const data=res.data;

// ðŸ”· TOTAL FY
let fyBusiness=0;
let fyBalance=0;

// ðŸ”· MTD TOTAL
let mtdBusiness=0;
let mtdCollection=0;

// ðŸ”· TOUR DATA
let tourBusiness=0;
let tourCollection=0;
let tourBalance=0;
let tourShops=0;
let tourActive=0;
let tourInactive=0;

let active=0,inactive=0;

let todayPartyArr=[];
let creditArr=[];

data.forEach(row=>{

let businessFY=cleanNumber(row["BUSINESS"]);
let balance=cleanNumber(row["BALANCE"]);
let businessMTD=cleanNumber(row["BUSINESS CURRENT MONTH"]);
let collectionMTD=cleanNumber(row["Collections Current Month"]);
let status=(row["ACCOUNT STATUS"]||"").toUpperCase();

fyBusiness+=businessFY;
fyBalance+=balance;

mtdBusiness+=businessMTD;
mtdCollection+=collectionMTD;

if(status==="ACTIVE") active++; else inactive++;

if(todayAreas.includes(row["AREA"])){

tourShops++;

if(status==="ACTIVE") tourActive++;
else tourInactive++;

tourBusiness+=businessMTD;
tourCollection+=collectionMTD;
tourBalance+=balance;

todayPartyArr.push({
name:row["PARTY"],
balance
});

if(cleanNumber(row["AVG CREDIT CYCLE"])>45){
creditArr.push({
name:row["PARTY"],
credit:row["AVG CREDIT CYCLE"]
});
}

}

});

// âœ… HEADER
let totalCollectionFY=fyBusiness-fyBalance;
let percent=fyBusiness?(totalCollectionFY/fyBusiness)*100:0;

document.getElementById("totalBusiness").innerHTML=
`ðŸ’¼ Business: â‚¹${Math.round(fyBusiness).toLocaleString()}`;

document.getElementById("totalCollection").innerHTML=
`ðŸ’° Collection: â‚¹${Math.round(totalCollectionFY).toLocaleString()}`;

document.getElementById("businessStatus").innerHTML=
`Status: ${percent.toFixed(0)}%`;

let bar=document.getElementById("progressBar");
bar.style.width=percent+"%";

if(percent<40) bar.style.background="red";
else if(percent<70) bar.style.background="orange";
else bar.style.background="limegreen";

// âœ… QUICK STATS
document.getElementById("quickStats").innerHTML=
`Total Shops: ${data.length}<br>
Active: ${active} | Inactive: ${inactive}<br>
MTD Business: â‚¹${Math.round(mtdBusiness).toLocaleString()}<br>
MTD Collection: â‚¹${Math.round(mtdCollection).toLocaleString()}`;

// âœ… TOUR STATS
let target=tourBalance*0.30;
let achievement=target?(tourCollection/target*100):0;

document.getElementById("tourStats").innerHTML=
`Total Shops: ${tourShops}<br>
Active: ${tourActive} | Inactive: ${tourInactive}<br>
MTD Business: â‚¹${Math.round(tourBusiness).toLocaleString()}<br>
MTD Collection: â‚¹${Math.round(tourCollection).toLocaleString()}<br>
Target: â‚¹${Math.round(target).toLocaleString()}<br>
Achievement: ${achievement.toFixed(0)}%`;

// âœ… TARGET
document.getElementById("dailyTarget").innerText=
"â‚¹"+Math.round(target).toLocaleString();

// âœ… ROUTE LIST
document.getElementById("todayCount").innerHTML=
`Total Parties: ${todayPartyArr.length}`;

document.getElementById("todayParties").innerHTML=
todayPartyArr.map(p=>`<li onclick="showParty('${p.name}')">
${p.name} â€“ â‚¹${p.balance.toLocaleString()}
</li>`).join("");

// âœ… CREDIT LIST
document.getElementById("creditCount").innerHTML=
`Total Parties: ${creditArr.length}`;

document.getElementById("creditExceeded").innerHTML=
creditArr.map(c=>`<li onclick="showParty('${c.name}')">
${c.name} â€“ ${c.credit} days
</li>`).join("");

}

});

}

loadData();
setInterval(loadData,300000);

</script>
