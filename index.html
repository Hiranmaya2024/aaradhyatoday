<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA TODAY</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.main{display:flex;height:100vh}
.left{width:40%;overflow:auto;background:#fff}
.right{width:60%;padding:10px}
.card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
#map{height:260px;border-radius:10px}

.party{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.block{border-left:4px solid red}
.active{border-left:4px solid green}

.btn{padding:8px 12px;border:none;border-radius:8px;color:#fff;margin:5px 5px 0 0}
.stop{background:#f97316}
.collect{background:#2563eb}
.go{background:#16a34a}
.disabled{background:#9ca3af}

.progressBar{height:10px;background:#e5e7eb;border-radius:10px;overflow:hidden;margin-top:6px}
.progressFill{height:100%;background:#16a34a;width:0%}
</style>

</head>
<body>

<div class="main">

<div class="left">
<div class="card" id="summary"></div>
<div id="partyList"></div>
</div>

<div class="right">

<div class="card" id="aiBox">Start journey</div>
<div id="map"></div>
<div class="card" id="partyCard"></div>

</div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
Monday:["JURIA"],
Tuesday:["GHESS"],
Wednesday:["GAISILATE"],
Thursday:["JHARBANDH"],
Friday:["PADAMPUR"],
Saturday:["PAIKMAL","MANDOSIL"]
};

let map = L.map('map').setView([20.9,83.4],10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let data=[],today=[],route=[],visits=[],markers=[];
let userLat,userLng,totalStops=0;

let visitState={current:null,startTime:null,amount:0};

const num=v=>Number(String(v||0).replace(/[^0-9.-]/g,""))||0;

function todayName(){
let d=new Date().toLocaleDateString("en-US",{weekday:"long"});
return tourPlan[d]?d:"Monday";
}

function load(){
Papa.parse(CSV,{
download:true,header:true,skipEmptyLines:true,
complete:res=>{
data=res.data.map(r=>({
party:(r["PARTY"]||"").trim(),
area:(r["AREA"]||"").toUpperCase().trim(),
status:(r["ACCOUNT STATUS"]||"").trim(),
balance:num(r["BALANCE"]),
credit:num(r["AVG CREDIT CYCLE"]),
reactivate:num(r["Payment needed to Reactivate"]),
lat:parseFloat(r["LAT"]),
lng:parseFloat(r["LNG"])
})).filter(x=>x.party);
init();
}});
}

function init(){
render();
navigator.geolocation.getCurrentPosition(pos=>{
userLat=pos.coords.latitude;
userLng=pos.coords.longitude;
L.marker([userLat,userLng]).addTo(map);
});
}

function render(){

let areas=tourPlan[todayName()];
today=data.filter(x=>areas.includes(x.area));

route=[...today];
totalStops=route.length;

renderSummary();

partyList.innerHTML=today.map(p=>`
<div class="party ${p.status==="BLOCK"?"block":"active"}"
onclick="showParty('${p.party}')">${p.party}</div>`).join("");

drawMap();
nextVisit();

}

function renderSummary(){

let collected=visits.reduce((a,b)=>a+b.amount,0);
let recoverable=today.reduce((a,b)=>a+b.reactivate,0)-collected;
let progress=totalStops?(visits.length/totalStops)*100:0;

summary.innerHTML=`
ðŸ’° Collected â‚¹${collected}<br>
ðŸŽ¯ Remaining â‚¹${recoverable}<br>
ðŸ“Š Progress ${progress.toFixed(0)}%
<div class="progressBar"><div class="progressFill" style="width:${progress}%"></div></div>
`;

}

function drawMap(){

markers.forEach(m=>map.removeLayer(m));
markers=[];

let valid=today.filter(p=>!isNaN(p.lat)&&!isNaN(p.lng));

let bounds=[];

valid.forEach(p=>{

let color="green";

if(visits.find(v=>v.party===p.party)) color="grey";
else if(route.length && route[0].party===p.party) color="gold";
else if(p.status==="BLOCK") color="red";

let marker=L.circleMarker([p.lat,p.lng],{
radius:8,color:color,fillOpacity:0.9
})
.addTo(map)
.on("click",()=>showParty(p.party));

markers.push(marker);
bounds.push([p.lat,p.lng]);

});

if(bounds.length) map.fitBounds(bounds);

}

function nextVisit(){

if(!route.length){
aiBox.innerHTML="âœ… Route Completed";
return;
}

let p=route[0];

aiBox.innerHTML=`
<h3>${p.party}</h3>
â‚¹${p.balance} || ${p.credit} days<br><br>

<button class="btn stop" onclick="startVisit()">STOP</button>
<button class="btn collect disabled" id="collectBtn" onclick="collect()">COLLECT</button>
<button class="btn go disabled" id="goBtn" onclick="endVisit()">GO</button>
`;

visitState={current:p,startTime:null,amount:0};

}

function startVisit(){
visitState.startTime=new Date();
collectBtn.classList.remove("disabled");
}

function collect(){
visitState.amount=num(prompt("Enter amount"));
goBtn.classList.remove("disabled");
}

function endVisit(){

visits.push({
party:visitState.current.party,
amount:visitState.amount,
duration:(new Date()-visitState.startTime)/1000
});

route.shift();

renderSummary();
drawMap();
nextVisit();

}

function showParty(name){

let p=data.find(x=>x.party===name);

partyCard.innerHTML=`
<h3>${p.party}</h3>
Outstanding â‚¹${p.balance}<br>
Credit ${p.credit} days
`;

}

load();

</script>
</body>
</html>