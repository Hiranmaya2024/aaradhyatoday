<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA TODAY</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f3fbf9;}
.header{background:linear-gradient(90deg,#1e8e7e,#2fa36b);color:white;text-align:center;padding:14px;}
.container{padding:12px;}
.card{background:white;padding:14px;margin-bottom:12px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.flex{display:flex;gap:10px;}
.flex .card{flex:1;}
.big{font-size:20px;font-weight:bold;color:#1e8e7e;}
ul{padding-left:18px;margin:0;}
canvas{max-height:260px;}
</style>
</head>

<body>

<div class="header"><b>AARADHYA TODAY</b></div>

<div class="container">

<!-- TOTAL -->
<div class="flex">
<div class="card">Total Business<div id="business" class="big">â‚¹0</div></div>
<div class="card">Total Collection<div id="collection" class="big">â‚¹0</div></div>
</div>

<!-- MONTH -->
<div class="flex">
<div class="card">This Month Business<div id="monthBusiness" class="big">â‚¹0</div></div>
<div class="card">This Month Collection<div id="monthCollection" class="big">â‚¹0</div></div>
</div>

<div class="card">Pending Bills to Collect<div id="pendingBills" class="big">0</div></div>

<div class="card"><canvas id="chart"></canvas></div>

<div class="card"><b>ðŸš¨ Top 10 High Risk Parties</b><ul id="riskParties"></ul></div>

<div class="card"><b>ðŸ“Œ Top 10 Credit Cycle Exceeded</b><ul id="creditExceeded"></ul></div>

<div class="card"><b>ðŸŽ¯ Todayâ€™s Collection Target (30% of Balance)</b><div id="dailyTarget" class="big"></div></div>

</div>

<script>

const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

let chart;

function cleanNumber(val){
return Number(String(val || 0).replace(/[^0-9.-]/g,"")) || 0;
}

function normalize(text){
return text.toLowerCase().replace(/[^a-z]/g,"");
}

function loadData(){

Papa.parse(sheetURL,{
download:true,
header:true,
skipEmptyLines:true,

complete:function(res){

const data = res.data;
const columns = Object.keys(data[0]);

const col = name => columns.find(c => normalize(c).includes(name));

// MAIN COLUMNS
const BUSINESS = col("business");
const BALANCE = col("balance");
const PENDING = col("pendingbills");
const RISK = col("balanceasofbusiness");
const CREDIT = col("avgcreditcycle");
const PARTY = col("party");

// MONTHLY (K & M)
const MONTH_BUSINESS = columns[10];
const MONTH_COLLECTION = columns[12];

let totalBusiness=0,totalBalance=0,totalPending=0;
let monthBusiness=0,monthCollection=0;

let riskArr=[],creditArr=[];

data.forEach(row=>{

let business = cleanNumber(row[BUSINESS]);
let balance = cleanNumber(row[BALANCE]);
let pending = cleanNumber(row[PENDING]);

let mBusiness = cleanNumber(row[MONTH_BUSINESS]);
let mCollection = cleanNumber(row[MONTH_COLLECTION]);

let risk = cleanNumber(row[RISK]);
let credit = cleanNumber(row[CREDIT]);

totalBusiness += business;
totalBalance += balance;
totalPending += pending;

monthBusiness += mBusiness;
monthCollection += mCollection;

if(risk>0) riskArr.push({party:row[PARTY],balance,risk});
if(credit>45) creditArr.push({party:row[PARTY],credit});

});

let totalCollection = totalBusiness - totalBalance;

// KPI DISPLAY
document.getElementById("business").innerText="â‚¹"+totalBusiness.toLocaleString();
document.getElementById("collection").innerText="â‚¹"+totalCollection.toLocaleString();
document.getElementById("pendingBills").innerText=totalPending.toLocaleString();
document.getElementById("monthBusiness").innerText="â‚¹"+monthBusiness.toLocaleString();
document.getElementById("monthCollection").innerText="â‚¹"+monthCollection.toLocaleString();

// SORT & LIMIT
riskArr.sort((a,b)=>b.risk-a.risk);
creditArr.sort((a,b)=>b.credit-a.credit);

const topRisk = riskArr.slice(0,10);
const topCredit = creditArr.slice(0,10);

// DISPLAY
document.getElementById("riskParties").innerHTML =
topRisk.map(r=>`<li>${r.party} â€“ â‚¹${r.balance.toLocaleString()} â€“ ${r.risk}%</li>`).join("");

document.getElementById("creditExceeded").innerHTML =
topCredit.map(c=>`<li>${c.party} â€“ ${c.credit} days</li>`).join("");

// TARGET = 30% BALANCE
let target = totalBalance * 0.30;
document.getElementById("dailyTarget").innerText="â‚¹"+Math.round(target).toLocaleString();

// CHART SAFE RELOAD
if(chart) chart.destroy();

chart = new Chart(document.getElementById("chart"),{
type:'doughnut',
data:{
labels:["Total Business","Total Collection"],
datasets:[{
data:[totalBusiness,totalCollection],
backgroundColor:["#2fa36b","#1e8e7e"]
}]
}
});

}

});

}

loadData();
setInterval(loadData,300000);

</script>

</body>
</html>