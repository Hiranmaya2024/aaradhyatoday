<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f1f5f9}
#map{height:58vh}
.panel{padding:12px;background:#fff}
button,select{width:100%;padding:14px;margin-top:8px;border-radius:10px;border:none;font-weight:bold}
.mainBtn{background:#16a34a;color:#fff}
</style>
</head>

<body>

<div class="panel" id="panel"></div>
<div id="map"></div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const ARRIVAL_RADIUS=0.05;
const SPEED=50;

let map=L.map("map").setView([20.9,83.4],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let live=[20.9,83.4];
let startPoint;

let data=[],today=[];
let visited=new Set();
let routePos;
let currentShop=null;

let journeyStart;
let totalCollection=0;
let expense=0;

let routeLine,userMarker;

const num=v=>Number(String(v||"").replace(/[^0-9.-]/g,""))||0;

navigator.geolocation.watchPosition(pos=>{
live=[pos.coords.latitude,pos.coords.longitude];
if(userMarker) map.removeLayer(userMarker);
userMarker=L.circleMarker(live,{radius:8,color:"blue",fillColor:"blue",fillOpacity:1}).addTo(map);
checkFinishEligibility();
});

function dist(a,b){
const R=6371;
let dLat=(b[0]-a[0])*Math.PI/180;
let dLon=(b[1]-a[1])*Math.PI/180;
let x=Math.sin(dLat/2)**2+
Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

async function load(){

panel.innerHTML="Loading data...";

const res=await fetch(CSV);
const text=await res.text();
const parsed=Papa.parse(text,{header:true});

data=parsed.data.map((r,i)=>({
id:i,
party:r.PARTY,
area:(r.AREA||"").toUpperCase(),
lat:num(r.LAT),
lng:num(r.LNG),
balance:num(r.BALANCE),
business:num(r.BUSINESS),
credit:num(r["AVG CREDIT CYCLE"]),
status:(r["ACCOUNT STATUS"]||"").toUpperCase(),
reactivation:num(r["PAYMENT NEEDED TO REACTIVATE"])
})).filter(x=>x.party);

renderDay("MONDAY");

}

function renderDay(day){

today=data;
visited.clear();
routePos=[...live];
startPoint=[...live];

panel.innerHTML=`<b>${day}</b>
<button class="mainBtn" onclick="startTour()">START TOUR</button>`;

drawPins();

}

function drawPins(){

today.forEach(p=>{
let color="gray";
if(visited.has(p.id)) color="green";
if(currentShop && currentShop.id===p.id) color="orange";

L.circleMarker([p.lat,p.lng],{radius:6,color}).addTo(map);
});

}

function buildRoute(){

let remaining=today.filter(p=>!visited.has(p.id));

let pos=[...routePos];
let coords=[pos];

while(remaining.length){

remaining.sort((a,b)=>dist(pos,[a.lat,a.lng])-dist(pos,[b.lat,b.lng]));

let next=remaining.shift();
coords.push([next.lat,next.lng]);
pos=[next.lat,next.lng];

}

coords.push(startPoint);

return coords;
}

function drawRoute(){

if(routeLine) map.removeLayer(routeLine);

routeLine=L.polyline(buildRoute(),{color:"blue",weight:4}).addTo(map);
map.fitBounds(routeLine.getBounds(),{padding:[40,40]});

}

function startTour(){

journeyStart=new Date();
goNext();

}

function goNext(){

let remaining=today.filter(p=>!visited.has(p.id));

if(!remaining.length){
panel.innerHTML+="<br>Return to start to finish tour";
return;
}

remaining.sort((a,b)=>dist(routePos,[a.lat,a.lng])-dist(routePos,[b.lat,b.lng]));

currentShop=remaining[0];

drawRoute();

panel.innerHTML=`
<b>${currentShop.party}</b>
₹${currentShop.balance}
<button class="mainBtn" onclick="visitFlow()">START VISIT</button>
`;

}

function visitFlow(){

let amt=prompt("Enter collection");
totalCollection+=num(amt);

visited.add(currentShop.id);
routePos=[currentShop.lat,currentShop.lng];

goNext();

}

function checkFinishEligibility(){

if(!startPoint) return;

if(dist(live,startPoint)<ARRIVAL_RADIUS && visited.size===today.length){

panel.innerHTML=`<button class="mainBtn" onclick="finishTour()">FINISH TOUR</button>`;

}

}

function finishTour(){

expense=num(prompt("Enter expense"));

let totalDistance=routeLine.getLatLngs().reduce((a,c,i,arr)=>{
if(i==0) return 0;
return a+dist([arr[i-1].lat,arr[i-1].lng],[c.lat,c.lng]);
},0);

let summary=`
Distance: ${totalDistance.toFixed(2)} km
Collection: ₹${totalCollection}
Expense: ₹${expense}
Net: ₹${totalCollection-expense}
`;

panel.innerHTML=`<pre>${summary}</pre>
<button onclick="window.open('https://wa.me/?text='+encodeURIComponent(summary))">Share WhatsApp</button>
<button onclick="download(summary)">Download</button>`;

}

function download(text){
let blob=new Blob([text]);
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="tour_report.txt";
a.click();
}

load();

</script>
</body>
</html>