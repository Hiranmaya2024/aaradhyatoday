<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>AARADHYA SMART TOUR</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.header{background:#fff;padding:10px;text-align:center;border-bottom:1px solid #ddd}
.main{display:flex;height:calc(100vh - 110px)}
.left{width:40%;overflow:auto;background:#fff}
.right{width:60%;padding:10px}
.card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
#map{height:260px;border-radius:10px}

.bigBtn{width:100%;padding:18px;font-size:18px;font-weight:bold;border:none;border-radius:12px;color:#fff;margin-top:10px}
.stop{background:#f97316}
.collect{background:#2563eb}
.go{background:#16a34a}

.smallRow{display:flex;gap:10px;margin-top:10px}
.smallBtn{flex:1;padding:10px;border:none;border-radius:8px;color:#fff;font-weight:bold}
.call{background:#0284c7}
.nav{background:#7c3aed}

.progressBar{height:10px;background:#e5e7eb;border-radius:10px;margin-top:6px}
.progressFill{height:100%;background:#16a34a;width:0%}

@media(max-width:768px){
.main{flex-direction:column}
.left,.right{width:100%}
}
</style>
</head>

<body>

<div class="header">
<b>Select Day:</b>
<select id="daySelect"></select>
<div id="areaInfo"></div>
</div>

<div class="main">

<div class="left">
<div class="card" id="summary"></div>
</div>

<div class="right">
<div class="card" id="aiBox"></div>
<div id="map"></div>
</div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
MONDAY:["JURIA"],
TUESDAY:["GHESS"],
WEDNESDAY:["GAISILATE"],
THURSDAY:["JHARBANDH"],
FRIDAY:["PADAMPUR"],
SATURDAY:["PAIKMAL","MANDOSIL"]
};

let data=[],today=[],visits=[];
let stage="stop",visitStart,visitAmount=0;
let userLat=20.9,userLng=83.4,totalDistance=0,journeyStartTime=null;

let map=L.map('map').setView([20.9,83.4],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const num=v=>Number(String(v||0).replace(/[^0-9.-]/g,""))||0;

function getDistance(a,b,c,d){
const R=6371;
const dLat=(c-a)*Math.PI/180;
const dLon=(d-b)*Math.PI/180;
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

Object.keys(tourPlan).forEach(d=>{
daySelect.innerHTML+=`<option value="${d}">${d}</option>`;
});

daySelect.value=new Date().toLocaleDateString("en-US",{weekday:"long"}).toUpperCase();
daySelect.onchange=render;

function load(){
Papa.parse(CSV,{
download:true,header:true,
complete:res=>{
data=res.data.map(r=>({
party:r.PARTY,
area:r.AREA.toUpperCase(),
phone:r.PHONE,
balance:num(r.BALANCE),
credit:num(r["AVG CREDIT CYCLE"]),
lat:parseFloat(r.LAT),
lng:parseFloat(r.LNG)
}));
render();
}});
}

function render(){

visits=[];
totalDistance=0;
journeyStartTime=null;

let areas=tourPlan[daySelect.value];

today=data.filter(d=>areas.some(a=>d.area.includes(a)));

nextVisit();
renderSummary();
}

function nextVisit(){

let pending=today.filter(p=>!visits.find(v=>v.party===p.party));

if(!pending.length){
generateFinalReport();
return;
}

let p=pending[0];

aiBox.innerHTML=`
<h3>${p.party}</h3>
â‚¹${p.balance} | ${p.credit} days

<div class="smallRow">
<button class="smallBtn call" onclick="callParty('${p.phone}')">ğŸ“ Call</button>
<button class="smallBtn nav" onclick="navigateTo(${p.lat},${p.lng})">ğŸ§­ Navigate</button>
</div>

<button id="actionBtn" onclick="nextStage()" class="bigBtn stop">ğŸŸ  START VISIT</button>
`;

visitState=p;
}

function callParty(phone){window.location.href=`tel:${phone}`;}
function navigateTo(lat,lng){window.open(`https://www.google.com/maps?q=${lat},${lng}`);}

function nextStage(){

if(stage==="stop"){
journeyStartTime ??= new Date();
visitStart=new Date();
stage="collect";
actionBtn.innerHTML="ğŸ”µ ENTER COLLECTION";
actionBtn.className="bigBtn collect";
return;
}

if(stage==="collect"){
visitAmount=num(prompt("Enter collection"));
stage="go";
actionBtn.innerHTML="ğŸŸ¢ COMPLETE VISIT";
actionBtn.className="bigBtn go";
return;
}

if(stage==="go"){completeVisit();stage="stop";}
}

function completeVisit(){

let timeSpent=(new Date()-visitStart)/1000;

let distance=visits.length
? getDistance(userLat,userLng,visitState.lat,visitState.lng)
: 0;

totalDistance+=distance;

visits.push({
party:visitState.party,
amount:visitAmount,
time:timeSpent,
distance:distance
});

userLat=visitState.lat;
userLng=visitState.lng;

renderSummary();
nextVisit();
}

function renderSummary(){

let collected=visits.reduce((a,b)=>a+b.amount,0);

let progress=today.length?(visits.length/today.length)*100:0;

summary.innerHTML=`
ğŸ’° â‚¹${collected}<br>
Visits ${visits.length}/${today.length}
<div class="progressBar"><div class="progressFill" style="width:${progress}%"></div></div>
`;
}

async function generateFinalReport(){

await new Promise(r=>setTimeout(r,1000));

let canvas=await html2canvas(map.getContainer());
let img=canvas.toDataURL("image/png");

let totalCollection=visits.reduce((a,b)=>a+b.amount,0);
let totalTime=(new Date()-journeyStartTime)/3600000;
let recoveryPerKm=totalDistance?(totalCollection/totalDistance).toFixed(0):0;

let visitLog=visits.map((v,i)=>`
${i+1}. ${v.party}
ğŸ“ ${v.distance.toFixed(2)} km
â± ${(v.time/60).toFixed(1)} min
ğŸ’° â‚¹${v.amount}`).join("<br><br>");

let msg=`ğŸ Route Completed
ğŸ“ ${totalDistance.toFixed(2)} km
ğŸ’° â‚¹${totalCollection}
â± ${totalTime.toFixed(2)} hrs
ğŸª ${visits.length}
ğŸ“Š â‚¹${recoveryPerKm}/km`;

let wa=`https://wa.me/?text=${encodeURIComponent(msg)}`;

aiBox.innerHTML=`
<h2>ğŸ Route Completed</h2>

${visitLog}<br><br>

ğŸ“ Distance: <b>${totalDistance.toFixed(2)} km</b><br>
ğŸ’° Collection: <b>â‚¹${totalCollection}</b><br>
â± Time: <b>${totalTime.toFixed(2)} hrs</b><br>
ğŸª Visits: <b>${visits.length}</b><br>
ğŸ“Š Recovery/km: <b>â‚¹${recoveryPerKm}</b><br><br>

<a href="${wa}" target="_blank">
<button class="bigBtn go">ğŸ“¤ Share on WhatsApp</button>
</a>
`;
}

load();

</script>
</body>
</html>