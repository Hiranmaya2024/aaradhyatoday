<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AAradhya Customers</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{font-family:Poppins;margin:0;background:#f4f6f9}
#launch{height:100vh;display:flex;justify-content:center;align-items:center;text-align:center;background:#0f2027;color:#fff}
.header{background:#0d6efd;color:#fff;padding:14px;font-weight:600}
.searchBox{padding:10px;background:#fff}
input{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd}

.list{padding:10px;display:grid;gap:10px}
.customer{background:#fff;padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}

.card{background:#fff;margin:12px;padding:18px;border-radius:14px}
.row{display:flex;justify-content:space-between;margin:6px 0}

.actions{position:fixed;bottom:0;width:100%;background:#fff;display:flex;gap:10px;padding:10px}
button{flex:1;padding:14px;border:none;border-radius:10px;color:#fff;font-weight:600}
.call{background:#28a745}.wa{background:#25D366}.nav{background:#0d6efd}

.tourBtn{background:#ff9800;margin-top:10px;width:100%}
</style>
</head>

<body>

<div id="launch" onclick="startApp()">
<div>
<h2>Welcome to</h2>
<h1>AAradhya Pharmaceuticals</h1>
<p>Tap to continue</p>
</div>
</div>

<div id="listScreen" style="display:none">

<div class="header">Customers</div>

<div class="searchBox">
<input type="text" placeholder="Search customer..." onkeyup="searchCustomer(this.value)">
<button class="tourBtn" onclick="startTour()">üß≠ Start Today‚Äôs Tour</button>
</div>

<div class="list" id="customerList"></div>
</div>

<div id="profileScreen" style="display:none">
<div class="header" onclick="goBack()">‚¨Ö Customer Profile</div>
<div id="profileCard"></div>

<div class="actions">
<button class="call" onclick="call()">Call</button>
<button class="wa" onclick="whatsapp()">WhatsApp</button>
<button class="nav" onclick="navigate()">Navigate</button>
</div>
</div>

<script>

const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

const tourPlan={
Monday:["Juria"],
Tuesday:["Ghess"],
Wednesday:["Gaisilate"],
Thursday:["Dava"],
Friday:["Padampur"],
Saturday:["Paikmal","Mandosil"]
}

let customers=[],todayRoute=[],selected={}
let userLat=null,userLng=null

const today=new Date().toLocaleDateString('en-US',{weekday:'long'})
const todayAreas=tourPlan[today]||[]

navigator.geolocation.getCurrentPosition(pos=>{
userLat=pos.coords.latitude
userLng=pos.coords.longitude
renderList(customers)
})

function startApp(){
launch.style.display="none"
listScreen.style.display="block"
}

/* CSV parser */
function parseCSV(text){
const rows=[];let row=[],value="",insideQuotes=false
for(let char of text){
if(char=='"'){insideQuotes=!insideQuotes;continue}
if(char==","&&!insideQuotes){row.push(value);value="";continue}
if((char=="\n"||char=="\r")&&!insideQuotes){
if(value||row.length){row.push(value);rows.push(row)}
row=[];value="";continue}
value+=char}
return rows
}

fetch(csvUrl)
.then(res=>res.text())
.then(text=>{

let rows=parseCSV(text).slice(1).filter(r=>r[0])

customers=rows.map(r=>({

name:r[0],          // A
area:r[1],          // B
status:r[2],        // C
reason:r[3],        // D
reactivate:r[4],    // E
business:r[5],      // F
due:parseFloat(r[6])||0, // G
phone:r[13],        // N
lat:parseFloat(r[14]),
lng:parseFloat(r[15]),
lastSale:r[17],     // R
lastCollection:r[18] // S

}))

customers.sort((a,b)=>b.due-a.due)

todayRoute=customers.filter(c=>todayAreas.includes(c.area))

renderList(customers)

})

function getDistance(lat,lng){
if(!lat||!lng) return "‚Äî"
if(!userLat) return "Locating..."
const R=6371
const dLat=(lat-userLat)*Math.PI/180
const dLng=(lng-userLng)*Math.PI/180
const a=Math.sin(dLat/2)**2+
Math.cos(userLat*Math.PI/180)*
Math.cos(lat*Math.PI/180)*
Math.sin(dLng/2)**2
return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1)+" km"
}

function renderList(data){
customerList.innerHTML=""
data.forEach((c,i)=>{

let bg="#fff"
if(c.status?.toLowerCase().includes("blocked")) bg="#ffebee"
else if(c.due>0) bg="#fff3cd"

customerList.innerHTML+=`
<div class="customer" onclick="openProfile(${i})" style="background:${bg}">
<b>${c.name}</b><br>
${c.area} | ‚Çπ${c.due} | üìç ${getDistance(c.lat,c.lng)}
</div>`
})
}

function openProfile(i){
selected=customers[i]

listScreen.style.display="none"
profileScreen.style.display="block"

profileCard.innerHTML=`
<div class="card">

<h3>${selected.name}</h3>

<div class="row"><div>Phone</div><div><a href="tel:${selected.phone}">${selected.phone}</a></div></div>
<div class="row"><div>Area</div><div>${selected.area}</div></div>
<div class="row"><div>Total Business</div><div>‚Çπ${selected.business}</div></div>
<div class="row"><div>Total Due</div><div>‚Çπ${selected.due}</div></div>
<div class="row"><div>Last Sale</div><div>${selected.lastSale}</div></div>
<div class="row"><div>Last Collection</div><div>${selected.lastCollection}</div></div>
<div class="row"><div>Account Status</div><div>${selected.status}</div></div>
<div class="row"><div>Reason</div><div>${selected.reason}</div></div>
<div class="row"><div>Reactivate by Paying</div><div>‚Çπ${selected.reactivate}</div></div>

</div>`
}

function goBack(){
profileScreen.style.display="none"
listScreen.style.display="block"
}

function searchCustomer(val){
renderList(customers.filter(c=>c.name.toLowerCase().includes(val.toLowerCase())))
}

function call(){window.location.href="tel:"+selected.phone}

function whatsapp(){
let msg=`Dear ${selected.name},

Your outstanding balance is ‚Çπ${selected.due}.

Kindly make the payment to continue smooth supply.

AAradhya Pharmaceuticals`
window.open(`https://wa.me/91${selected.phone}?text=${encodeURIComponent(msg)}`)
}

function navigate(){
window.open(`https://www.google.com/maps?q=${selected.lat},${selected.lng}`)
}

function startTour(){
let route=todayRoute.filter(c=>c.lat&&c.lng).map(c=>`${c.lat},${c.lng}`).join("/")
window.open(`https://www.google.com/maps/dir/${userLat},${userLng}/${route}`)
}

</script>

</body>
</html>