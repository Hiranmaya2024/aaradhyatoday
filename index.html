<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA TODAY</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.header{background:#fff;padding:10px;text-align:center;border-bottom:1px solid #ddd}
.main{display:flex;height:calc(100vh - 70px)}
.left{width:40%;overflow:auto;background:#fff}
.right{width:60%;padding:10px}
.card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
#map{height:260px;border-radius:10px}
.party{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.block{border-left:4px solid red}
.active{border-left:4px solid green}
@media(max-width:768px){.main{flex-direction:column}.left,.right{width:100%}}
</style>

</head>
<body>

<div class="header">

<b>Select Day:</b>
<select id="daySelect"></select>

<div id="statusMsg">Loading CSV...</div>
<div id="areaInfo"></div>

</div>

<div class="main">

<div class="left">
<div class="card" id="summary"></div>
<div id="partyList"></div>
</div>

<div class="right">
<div id="map"></div>
<div class="card" id="partyCard">Select a party</div>
</div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
MONDAY:["JURIA"],
TUESDAY:["GHESS"],
WEDNESDAY:["GAISILATE"],
THURSDAY:["JHARBANDH"],
FRIDAY:["PADAMPUR"],
SATURDAY:["PAIKMAL","MANDOSIL"]
};

// ðŸŒ INIT MAP
let map = L.map('map').setView([20.9,83.4],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let data=[],today=[],markers=[];

// âœ… LOAD DAY DROPDOWN FIRST (so it never depends on CSV)
function populateDayDropdown(){

daySelect.innerHTML="";

Object.keys(tourPlan).forEach(d=>{
daySelect.innerHTML+=`<option value="${d}">${d}</option>`;
});

daySelect.value=new Date().toLocaleDateString("en-US",{weekday:"long"}).toUpperCase();

daySelect.onchange=render;

}

// ðŸ”¢ SAFE NUMBER
const num=v=>Number(String(v||0).replace(/[^0-9.-]/g,""))||0;

// ðŸ“¥ LOAD CSV
function loadCSV(){

Papa.parse(CSV,{
download:true,
header:true,
skipEmptyLines:true,

complete:(res)=>{

statusMsg.innerHTML=`CSV Loaded âœ… Rows: ${res.data.length}`;

data=res.data.map(r=>({

party:(r["PARTY"]||"").trim(),
area:(r["AREA"]||"").toUpperCase().trim(),
status:(r["ACCOUNT STATUS"]||"").trim(),
balance:num(r["BALANCE"]),
credit:num(r["AVG CREDIT CYCLE"]),
lat:parseFloat(r["LAT"]),
lng:parseFloat(r["LNG"])

})).filter(x=>x.party);

render();

},

error:(err)=>{
statusMsg.innerHTML="âŒ CSV LOAD FAILED";
console.error(err);
}

});

}

// ðŸŽ¯ RENDER
function render(){

let day=daySelect.value;

let areas=tourPlan[day]||[];

areaInfo.innerHTML=`Areas: ${areas.join(", ")}`;

today=data.filter(x=>areas.includes(x.area));

summary.innerHTML=`Total Parties: <b>${today.length}</b>`;

partyList.innerHTML=today.map(p=>`
<div class="party ${p.status==="BLOCK"?"block":"active"}"
onclick="showParty('${p.party}')">
${p.party}<br>â‚¹${p.balance}
</div>`).join("");

drawMap();

}

// ðŸ—º DRAW MAP
function drawMap(){

markers.forEach(m=>map.removeLayer(m));
markers=[];

let bounds=[];

today.forEach(p=>{

if(isNaN(p.lat)||isNaN(p.lng)) return;

let marker=L.circleMarker([p.lat,p.lng],{
radius:8,
color:p.status==="BLOCK"?"red":"green",
fillOpacity:0.9
})
.addTo(map)
.on("click",()=>showParty(p.party));

markers.push(marker);
bounds.push([p.lat,p.lng]);

});

if(bounds.length) map.fitBounds(bounds);

}

// ðŸ‘¤ PARTY CARD
function showParty(name){

let p=data.find(x=>x.party===name);

partyCard.innerHTML=`
<h3>${p.party}</h3>
Area: ${p.area}<br>
Outstanding â‚¹${p.balance}<br>
Credit ${p.credit} days
`;

}

// ðŸš€ START
populateDayDropdown();
loadCSV();

</script>

</body>
</html>