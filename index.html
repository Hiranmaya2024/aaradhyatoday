<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{margin:0;font-family:Arial}
#map{height:100vh}
.panel{
position:absolute;
top:10px;left:10px;right:10px;
background:#fff;padding:12px;border-radius:10px;
z-index:1000;font-size:14px;
}
</style>

</head>

<body>

<div class="panel" id="panel">ğŸš€ Initializingâ€¦</div>
<div id="map"></div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
MONDAY:["JURIA"],
TUESDAY:["GHESS"],
WEDNESDAY:["GAISILATE"],
THURSDAY:["JHARBANDH"],
FRIDAY:["PADAMPUR"],
SATURDAY:["PAIKMAL","MANDOSIL"]
};

let map=L.map('map').setView([20.9,83.4],11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userLat=20.9,userLng=83.4;
let userMarker;
let data=[],today=[];
let partyMarkers=[];

const num=v=>Number(String(v||"").replace(/[^0-9.-]/g,""))||0;

function setPanel(html){
document.getElementById("panel").innerHTML=html;
}

function getToday(){
return new Date().toLocaleDateString("en-US",{weekday:"long"}).toUpperCase();
}

function initGPS(){

setPanel("ğŸ“¡ Getting GPS locationâ€¦");

navigator.geolocation.getCurrentPosition(

pos=>{
userLat=pos.coords.latitude;
userLng=pos.coords.longitude;

map.setView([userLat,userLng],12);

userMarker=L.marker([userLat,userLng]).addTo(map)
.bindPopup("You are here");

loadCSV();
},

()=>{
setPanel("âš  GPS denied â€” using default location");
loadCSV();
}

);

}

function loadCSV(){

setPanel("â³ Loading route dataâ€¦");

Papa.parse(CSV,{
download:true,
header:true,

complete:res=>{

data=res.data.map(r=>({

party:r.PARTY,

area:(r.AREA||"").toUpperCase(),

lat:num(r.LAT),

lng:num(r.LNG),

balance:num(r.BALANCE),

credit:num(r["AVG CREDIT CYCLE"])

})).filter(x=>x.party);

renderToday();

},

error:()=>setPanel("âŒ CSV load failed")

});

}

function clearPartyMarkers(){
partyMarkers.forEach(m=>map.removeLayer(m));
partyMarkers=[];
}

function renderToday(){

const todayName=getToday();

const areas=tourPlan[todayName]||[];

today=data.filter(d=>
areas.some(a=>d.area.includes(a))
);

clearPartyMarkers();

let bounds=[];

today.forEach(p=>{

if(p.lat && p.lng){

let marker=L.circleMarker([p.lat,p.lng],{
radius:6,
color:"green"
}).addTo(map).bindPopup(
`<b>${p.party}</b><br>
â‚¹${p.balance}<br>
${p.credit} days`
);

partyMarkers.push(marker);
bounds.push([p.lat,p.lng]);

}

});

if(bounds.length){
map.fitBounds(bounds,{padding:[40,40]});
}

setPanel(`
<b>${todayName}</b><br>
ğŸ“ Location ready<br>
ğŸª Parties: ${today.length}
`);

}

initGPS();

</script>
</body>
</html>