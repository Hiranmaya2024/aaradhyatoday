<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA TODAY</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}

.header{position:sticky;top:0;background:#fff;padding:10px;border-bottom:1px solid #ddd;text-align:center}

.card{background:#fff;margin:6px;padding:10px;border-radius:10px;border:1px solid #e2e8f0}

.party{padding:10px;border-bottom:1px solid #eee;cursor:pointer}

.block{border-left:4px solid #ef4444}
.active{border-left:4px solid #22c55e}

.btn{padding:6px 10px;border-radius:8px;color:#fff;text-decoration:none;margin-right:6px;font-size:13px}
.call{background:#16a34a}
.wa{background:#25D366}
.nav{background:#2563eb}
.start{background:#0f766e}

.small{font-size:12px;color:#555}
</style>
</head>

<body>

<div class="header">

<select id="daySelect"></select>
<div id="dayArea"></div>
<div id="kpi"></div>

<button class="btn start" onclick="startJourney()">Start Journey</button>

</div>

<div class="card" id="journeyBox" style="display:none"></div>
<div class="card" id="summary"></div>
<div class="card" id="partyList"></div>
<div class="card" id="partyCard" style="display:none"></div>

<script>

const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
Monday:["JURIA"],
Tuesday:["GHESS"],
Wednesday:["GAISILATE"],
Thursday:["JHARBANDH"],
Friday:["PADAMPUR"],
Saturday:["PAIKMAL","MANDOSIL"]
};

let sheetData=[],routeData=[];
let startLat,startLng;

function num(v){return Number(String(v||0).replace(/[^0-9.-]/g,""))||0;}

function distance(a,b,c,d){
let R=6371;
let dLat=(c-a)*Math.PI/180;
let dLng=(d-b)*Math.PI/180;
let x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLng/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

function loadData(){
Papa.parse(url,{download:true,header:true,skipEmptyLines:true,
complete:function(res){sheetData=res.data;render();}
});
}

function render(){

let day=daySelect.value;

let data=sheetData.filter(r=>
tourPlan[day].includes((r["AREA"]||"").toUpperCase())
);

routeData=data;

renderList(data);
}

function startJourney(){

navigator.geolocation.getCurrentPosition(pos=>{

startLat=pos.coords.latitude;
startLng=pos.coords.longitude;

generateRoute();

});
}

function generateRoute(){

let remaining=[...routeData];
let ordered=[];
let totalDistance=0;

let currentLat=startLat;
let currentLng=startLng;

while(remaining.length){

let nearest=remaining.reduce((a,b)=>
distance(currentLat,currentLng,a["LAT"],a["LNG"])<
considerDistance(currentLat,currentLng,b["LAT"],b["LNG"])?a:b);

let d=distance(currentLat,currentLng,nearest["LAT"],nearest["LNG"]);

totalDistance+=d;

currentLat=nearest["LAT"];
currentLng=nearest["LNG"];

ordered.push(nearest);
remaining=remaining.filter(x=>x!==nearest);
}

routeData=ordered;

let time=(totalDistance/25)*60;

document.getElementById("journeyBox").style.display="block";
document.getElementById("journeyBox").innerHTML=

"ðŸ›£ "+totalDistance.toFixed(1)+" km | â± "+time.toFixed(0)+" mins | ðŸ“ "+ordered.length+" stops";

renderList(routeData);
}

function considerDistance(a,b,c,d){
return distance(a,b,c,d);
}

function renderList(data){

document.getElementById("partyList").innerHTML=

data.map(p=>`

<div class="party ${(p["ACCOUNT STATUS"]||"").toUpperCase()=="BLOCK"?"block":"active"}"
onclick="showParty('${p["PARTY"]}')">

<b>${p["PARTY"]}</b>
<div class="small">â‚¹${num(p["BALANCE"]).toLocaleString()}</div>

</div>

`).join("");
}

function showParty(name){

let p=sheetData.find(x=>x["PARTY"]===name);

let map=`https://www.google.com/maps?q=${p["LAT"]},${p["LNG"]}`;

document.getElementById("partyCard").style.display="block";

document.getElementById("partyCard").innerHTML=`

<b>${p["PARTY"]}</b><br>
${p["AREA"]}<br><br>

Balance â‚¹${num(p["BALANCE"]).toLocaleString()}<br>

<a class="btn call" href="tel:${p["PHONE"]}">Call</a>
<a class="btn wa" href="https://wa.me/91${p["PHONE"]}">WhatsApp</a>
<a class="btn nav" href="${map}" target="_blank">Navigate</a>

`;
}

Object.keys(tourPlan).forEach(d=>daySelect.innerHTML+=`<option>${d}</option>`);
daySelect.value=new Date().toLocaleDateString("en-US",{weekday:"long"});
daySelect.onchange=render;

loadData();

</script>
</body>
</html>