<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA TODAY</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.header{background:#fff;padding:10px;border-bottom:1px solid #ddd;text-align:center}
.main{display:flex;height:calc(100vh - 150px)}
.left{width:40%;overflow:auto;background:#fff}
.right{width:60%;padding:10px;overflow:auto}
.card{background:#fff;padding:10px;border-radius:10px;border:1px solid #e2e8f0;margin-bottom:10px}
.party{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.block{border-left:4px solid red}
.active{border-left:4px solid green}
.btn{padding:6px 10px;border-radius:8px;color:#fff;text-decoration:none;margin:5px 5px 0 0;display:inline-block}
.call{background:#16a34a}.wa{background:#25D366}.nav{background:#2563eb}.start{background:#0f766e}
iframe{width:100%;height:240px;border:0;border-radius:10px}
@media(max-width:768px){.main{flex-direction:column;height:auto}.left,.right{width:100%}}
</style>
</head>

<body>

<div class="header">
<select id="daySelect"></select>
<div id="dayArea"></div>
<button class="btn start" onclick="startJourney()">Start Journey</button>
<button class="btn start" onclick="getLocation()">Refresh AI</button>
</div>

<div class="main">

<div class="left">
<div class="card" id="summary"></div>
<div id="partyList"></div>
</div>

<div class="right">
<div class="card" id="aiBox">üìç Allow location for AI</div>
<div class="card" id="partyCard">Select a party</div>
<div id="mapBox"></div>
</div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
Monday:["JURIA"],
Tuesday:["GHESS"],
Wednesday:["GAISILATE"],
Thursday:["JHARBANDH"],
Friday:["PADAMPUR"],
Saturday:["PAIKMAL","MANDOSIL"]
};

let data=[],today=[],route=[];
let userLat,userLng;

const num=v=>Number(String(v||0).replace(/[^0-9.-]/g,""))||0;

function todayName(){
let d=new Date().toLocaleDateString("en-US",{weekday:"long"});
return tourPlan[d]?d:"Monday";
}

function load(){

Papa.parse(CSV,{
download:true,
header:true,
skipEmptyLines:true,
complete:res=>{

data=res.data.map(r=>({
party:r["PARTY"],
area:(r["AREA"]||"").toUpperCase(),
status:(r["ACCOUNT STATUS"]||"").toUpperCase(),
balance:num(r["BALANCE"]),
credit:num(r["AVG CREDIT CYCLE"]),
phone:r["PHONE"],
lat:Number(r["LAT"]),
lng:Number(r["LNG"]),
reactivate:num(r["Payment needed to Reactivate"]),
mtdB:num(r["BUSINESS CURRENT MONTH"]),
mtdC:num(r["Collections Current Month"])
})).filter(x=>x.party && x.area);

init();

}
});

}

function init(){

Object.keys(tourPlan).forEach(d=>daySelect.innerHTML+=`<option>${d}</option>`);
daySelect.value=todayName();
daySelect.onchange=render;

render();

}

function render(){

let areas=tourPlan[daySelect.value];

today=data.filter(x=>areas.includes(x.area));

let b=0,c=0,r=0;
today.forEach(x=>{b+=x.mtdB;c+=x.mtdC;r+=x.reactivate});

summary.innerHTML=`
üì¶ MTD Business ‚Çπ${b.toLocaleString()}<br>
üí∞ MTD Collection ‚Çπ${c.toLocaleString()}<br>
üéØ Recoverable ‚Çπ${r.toLocaleString()}
`;

partyList.innerHTML=today.map(p=>`
<div class="party ${p.status==="BLOCK"?"block":"active"}"
onclick="showParty('${p.party}')">
${p.party}<br>‚Çπ${p.balance.toLocaleString()}
</div>`).join("");

runAI();

}

function showParty(name){

let p=today.find(x=>x.party===name);

partyCard.innerHTML=`
<b>${p.party}</b><br>${p.area}<br>
Balance ‚Çπ${p.balance.toLocaleString()}<br>
Credit ${p.credit} days<br><br>

<a class="btn call" href="tel:${p.phone}">Call</a>
<a class="btn wa" href="https://wa.me/91${p.phone}">WhatsApp</a>
<a class="btn nav" href="https://www.google.com/maps?q=${p.lat},${p.lng}" target="_blank">Navigate</a>
`;

}

function distance(a,b,c,d){
let R=6371;
let dLat=(c-a)*Math.PI/180;
let dLon=(d-b)*Math.PI/180;
let x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

function getLocation(){

navigator.geolocation.getCurrentPosition(pos=>{
userLat=pos.coords.latitude;
userLng=pos.coords.longitude;
runAI();
});

}

function runAI(){

if(!userLat)return;

let best=[...today].map(p=>{
let dist=distance(userLat,userLng,p.lat,p.lng);
let score=(p.reactivate*0.6)+(p.credit*0.25)-(dist*0.15);
return {...p,dist,score};
}).sort((a,b)=>b.score-a.score)[0];

aiBox.innerHTML=`
üü¢ Next Visit<br><b>${best.party}</b><br>
‚Çπ${best.reactivate.toLocaleString()} ‚Ä¢ ${best.credit} days ‚Ä¢ ${best.dist.toFixed(1)} km
`;

}

function startJourney(){

navigator.geolocation.getCurrentPosition(pos=>{

userLat=pos.coords.latitude;
userLng=pos.coords.longitude;

let stops=today.filter(p=>p.lat && p.lng);

let remaining=[...stops];
route=[];

let clat=userLat,clng=userLng;

while(remaining.length){

let nearest=remaining.reduce((a,b)=>
distance(clat,clng,a.lat,a.lng)<
distance(clat,clng,b.lat,b.lng)?a:b);

route.push(nearest);
clat=nearest.lat;
clng=nearest.lng;
remaining=remaining.filter(x=>x!==nearest);

}

drawMap();
runAI();

});

}

function drawMap(){

let navURL="https://www.google.com/maps/dir/?api=1&origin="+
userLat+","+userLng+
"&destination="+route.at(-1).lat+","+route.at(-1).lng+
"&waypoints="+route.map(p=>p.lat+","+p.lng).join("|");

let previewURL=`https://www.google.com/maps?q=${route[0].lat},${route[0].lng}&z=13&output=embed`;

mapBox.innerHTML=`
<iframe src="${previewURL}"></iframe>
<a class="btn nav" href="${navURL}" target="_blank">üß≠ Open Full Route in Google Maps</a>
`;

}

load();

</script>
</body>
</html>