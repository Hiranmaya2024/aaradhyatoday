<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LIVE MR NAVIGATION</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>

body{margin:0;font-family:Arial;background:#f1f5f9}

#map{height:100vh}

.panel{
position:absolute;
top:10px;
left:10px;
right:10px;
background:#fff;
padding:12px;
border-radius:12px;
z-index:1000;
}

.bigBtn{
width:100%;
padding:14px;
border:none;
border-radius:10px;
color:#fff;
font-size:16px;
margin-top:8px;
}

.start{background:#16a34a}
.collect{background:#2563eb}
.complete{background:#f97316}

</style>
</head>

<body>

<div class="panel" id="info"></div>

<div id="map"></div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const SPEED=50;

let map=L.map('map').setView([20.9,83.4],12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userMarker,routeLine,visitedLine;

let parties=[],pending=[],visited=[];

let userLat,userLng,currentTarget;

const num=v=>Number(String(v||"").replace(/[^0-9.-]/g,""))||0;

function getDistance(a,b,c,d){
if(!a||!b||!c||!d)return 0;
const R=6371;
const dLat=(c-a)*Math.PI/180;
const dLon=(d-b)*Math.PI/180;
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

navigator.geolocation.watchPosition(pos=>{

userLat=pos.coords.latitude;
userLng=pos.coords.longitude;

if(userMarker) map.removeLayer(userMarker);

userMarker=L.marker([userLat,userLng]).addTo(map);

map.setView([userLat,userLng]);

updateNavigation();

});

function load(){

Papa.parse(CSV,{
download:true,header:true,
complete:res=>{

parties=res.data.map(r=>({
name:r.PARTY,
lat:num(r.LAT),
lng:num(r.LNG),
balance:num(r.BALANCE),
credit:num(r["AVG CREDIT CYCLE"])
}));

pending=[...parties];

drawRoute();

}

});

}

function drawRoute(){

let route=[ [userLat,userLng] ];

let tempLat=userLat,tempLng=userLng;

let temp=[...pending];

while(temp.length){

temp.forEach(p=>p.dist=getDistance(tempLat,tempLng,p.lat,p.lng));

temp.sort((a,b)=>a.dist-b.dist);

let next=temp.shift();

route.push([next.lat,next.lng]);

tempLat=next.lat;
tempLng=next.lng;

}

routeLine=L.polyline(route,{color:"blue"}).addTo(map);

}

function updateNavigation(){

if(!pending.length) return;

pending.forEach(p=>p.dist=getDistance(userLat,userLng,p.lat,p.lng));

pending.sort((a,b)=>a.dist-b.dist);

currentTarget=pending[0];

let remainingKm=pending.reduce((a,b)=>a+b.dist,0);

let eta=remainingKm/SPEED;

info.innerHTML=`

<b>Next:</b> ${currentTarget.name}<br>
‚Çπ${currentTarget.balance} | ${currentTarget.credit} days<br>
üìç ${currentTarget.dist.toFixed(2)} km<br>
‚è± ETA ${(eta).toFixed(2)} hr

<button class="bigBtn start" onclick="startVisit()">START VISIT</button>

`;

if(currentTarget.dist<0.05){
alert("Reached "+currentTarget.name);
}

}

function startVisit(){

info.innerHTML+=`
<button class="bigBtn collect" onclick="collect()">COLLECT</button>
`;

}

function collect(){

let amt=prompt("Enter collection");

visited.push(currentTarget);

pending=pending.filter(p=>p!==currentTarget);

drawRoute();

}

load();

</script>
</body>
</html>
