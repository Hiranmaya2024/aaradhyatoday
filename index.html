<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AAradhya Tour</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{font-family:Poppins;margin:0;background:#f4f6f9}
.header{background:#0d6efd;color:#fff;padding:14px;font-weight:600}

.routeBox{
background:#fff;margin:10px;padding:14px;border-radius:14px;
display:grid;grid-template-columns:1fr 1fr;gap:10px;
box-shadow:0 2px 10px rgba(0,0,0,0.08)
}

.partyList{max-height:160px;overflow:auto;font-size:13px}

.grid{padding:10px;display:grid;gap:12px}
.customer{background:#fff;padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}

.card{background:#fff;margin:12px;padding:18px;border-radius:14px}

.actions{position:fixed;bottom:0;width:100%;background:#fff;display:flex;gap:10px;padding:10px}
button{flex:1;padding:12px;border:none;border-radius:10px;color:#fff;font-weight:600}
.call{background:#28a745}.wa{background:#25D366}.nav{background:#0d6efd}
.tour{background:#ff9800;margin-top:10px;width:100%}

@media(min-width:700px){.grid{grid-template-columns:1fr 1fr}}
@media(min-width:1000px){.grid{grid-template-columns:1fr 1fr 1fr}}

</style>
</head>

<body>

<div class="header">AAradhya Tour Dashboard</div>

<div id="routeBox" class="routeBox">Loading route‚Ä¶</div>

<div id="customerGrid" class="grid"></div>

<div id="profileScreen" style="display:none">
<div class="header" onclick="goBack()">‚¨Ö Customer Profile</div>
<div id="profileCard"></div>

<div class="actions">
<button class="call" onclick="call()">Call</button>
<button class="wa" onclick="whatsapp()">WhatsApp</button>
<button class="nav" onclick="navigate()">Navigate</button>
</div>
</div>

<script>

const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

const tourPlan={
Monday:["Juria"],Tuesday:["Ghess"],Wednesday:["Gaisilate"],
Thursday:["Dava"],Friday:["Padampur"],Saturday:["Paikmal","Mandosil"]
}

let customers=[],todayRoute=[],selected={}
let userLat,userLng

const today=new Date().toLocaleDateString('en-US',{weekday:'long'})
const todayAreas=tourPlan[today]||[]

navigator.geolocation.getCurrentPosition(pos=>{
userLat=pos.coords.latitude
userLng=pos.coords.longitude
renderAll()
})

function parseCSV(text){
const rows=[];let row=[],value="",insideQuotes=false
for(let char of text){
if(char=='"'){insideQuotes=!insideQuotes;continue}
if(char==","&&!insideQuotes){row.push(value);value="";continue}
if((char=="\n"||char=="\r")&&!insideQuotes){
if(value||row.length){row.push(value);rows.push(row)}
row=[];value="";continue}
value+=char}
return rows
}

fetch(csvUrl)
.then(res=>res.text())
.then(text=>{

let rows=parseCSV(text).slice(1).filter(r=>r[0])

customers=rows.map(r=>({
name:r[0],area:r[1],status:r[2],reason:r[3],reactivate:r[4],
business:r[5],due:parseFloat(r[6])||0,phone:r[13],
lat:parseFloat(r[14]),lng:parseFloat(r[15]),
lastSale:r[17],lastCollection:r[18]
}))

customers.sort((a,b)=>b.due-a.due)
todayRoute=customers.filter(c=>todayAreas.includes(c.area))
renderAll()

})

function distance(lat,lng){
if(!lat||!userLat) return "‚Äî"
const R=6371
const dLat=(lat-userLat)*Math.PI/180
const dLng=(lng-userLng)*Math.PI/180
const a=Math.sin(dLat/2)**2+
Math.cos(userLat*Math.PI/180)*Math.cos(lat*Math.PI/180)*
Math.sin(dLng/2)**2
return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1)+" km"
}

function calcRoute(){
let total=0,prevLat=userLat,prevLng=userLng
todayRoute.forEach(p=>{
if(p.lat){
total+=parseFloat(distanceValue(prevLat,prevLng,p.lat,p.lng))
prevLat=p.lat;prevLng=p.lng}})
return total
}

function distanceValue(a,b,c,d){
const R=6371
const dLat=(c-a)*Math.PI/180
const dLng=(d-b)*Math.PI/180
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))
}

function renderAll(){

if(customers.length===0) return

let totalDist=calcRoute().toFixed(1)
let time=(totalDist/25).toFixed(1)

routeBox.innerHTML=`
<div>
<b>üóì Today‚Äôs Route ‚Äì ${todayAreas.join(", ")}</b><br>
Parties: ${todayRoute.length}<br>
üìè ${totalDist} km<br>
‚è± ${time} hrs
<button class="tour" onclick="startTour()">üß≠ Start Tour</button>
</div>

<div class="partyList">
${todayRoute.map((c,i)=>`
<div onclick="openProfileByName('${c.name}')">
${i+1}. ${c.name}<br>
üìç ${distance(c.lat,c.lng)}
</div>`).join("")}
</div>
`

customerGrid.innerHTML=""
customers.forEach(c=>{
customerGrid.innerHTML+=`
<div class="customer" onclick="openProfileByName('${c.name}')">
<b>${c.name}</b><br>
${c.area} | ‚Çπ${c.due} | üìç ${distance(c.lat,c.lng)}
</div>`
})

}

function openProfileByName(name){
selected=customers.find(c=>c.name===name)
customerGrid.style.display="none"
routeBox.style.display="none"
profileScreen.style.display="block"

profileCard.innerHTML=`
<div class="card">
<h3>${selected.name}</h3>
Phone: <a href="tel:${selected.phone}">${selected.phone}</a><br>
Area: ${selected.area}<br>
Total Business: ‚Çπ${selected.business}<br>
Total Due: ‚Çπ${selected.due}<br>
Last Sale: ${selected.lastSale}<br>
Last Collection: ${selected.lastCollection}<br>
Status: ${selected.status}<br>
Reason: ${selected.reason}<br>
Reactivate by Paying: ‚Çπ${selected.reactivate}
</div>`
}

function goBack(){
profileScreen.style.display="none"
customerGrid.style.display="grid"
routeBox.style.display="grid"
}

function startTour(){
let route=todayRoute.map(c=>`${c.lat},${c.lng}`).join("/")
window.open(`https://www.google.com/maps/dir/${userLat},${userLng}/${route}`)
}

function call(){window.location.href="tel:"+selected.phone}
function whatsapp(){window.open(`https://wa.me/91${selected.phone}`)}
function navigate(){window.open(`https://www.google.com/maps?q=${selected.lat},${selected.lng}`)}

</script>
</body>
</html>