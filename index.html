<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA TODAY</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.header{background:#fff;padding:10px;border-bottom:1px solid #ddd;text-align:center}
.main{display:flex;height:calc(100vh - 170px)}
.left{width:40%;overflow:auto;background:#fff}
.right{width:60%;padding:10px;overflow:auto}
.card{background:#fff;padding:14px;border-radius:12px;border:1px solid #e2e8f0;margin-bottom:12px}
.party{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.block{border-left:5px solid red}
.active{border-left:5px solid green}
.progressBar{height:10px;background:#e5e7eb;border-radius:10px;overflow:hidden;margin-top:6px}
.progressFill{height:100%;background:#16a34a;width:0%}
.btn{padding:8px 12px;border:none;border-radius:8px;color:#fff;margin:5px 5px 0 0}
.stop{background:#f97316}
.collect{background:#2563eb}
.go{background:#16a34a}
.disabled{background:#9ca3af}
iframe{width:100%;height:240px;border:0;border-radius:10px}
.legend{font-size:13px;margin-top:6px}
@media(max-width:768px){.main{flex-direction:column;height:auto}.left,.right{width:100%}}
</style>
</head>

<body>

<div class="header">
<select id="daySelect"></select>
<div id="dayArea"></div>
<button class="btn stop" onclick="startJourney()">Start Journey</button>
</div>

<div class="main">

<div class="left">
<div class="card" id="summary"></div>
<div id="partyList"></div>
</div>

<div class="right">

<div class="card" id="aiBox">Start journey to begin</div>
<div class="card" id="partyCard">Select a party</div>
<div id="mapBox"></div>

</div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
Monday:["JURIA"],
Tuesday:["GHESS"],
Wednesday:["GAISILATE"],
Thursday:["JHARBANDH"],
Friday:["PADAMPUR"],
Saturday:["PAIKMAL","MANDOSIL"]
};

let data=[],today=[],route=[],visits=[];
let userLat,userLng,totalStops=0;

let visitState={current:null,startTime:null,amount:0};

const num=v=>Number(String(v||0).replace(/[^0-9.-]/g,""))||0;

function todayName(){
let d=new Date().toLocaleDateString("en-US",{weekday:"long"});
return tourPlan[d]?d:"Monday";
}

function load(){
Papa.parse(CSV,{
download:true,header:true,skipEmptyLines:true,
complete:res=>{
data=res.data.map(r=>({
party:r["PARTY"],
area:(r["AREA"]||"").toUpperCase(),
status:r["ACCOUNT STATUS"],
balance:num(r["BALANCE"]),
credit:num(r["AVG CREDIT CYCLE"]),
phone:r["PHONE"],
lat:Number(r["LAT"]),
lng:Number(r["LNG"]),
reactivate:num(r["Payment needed to Reactivate"])
})).filter(x=>x.party);
init();
}});
}

function init(){
Object.keys(tourPlan).forEach(d=>daySelect.innerHTML+=`<option>${d}</option>`);
daySelect.value=todayName();
daySelect.onchange=render;
render();
}

function render(){

let areas=tourPlan[daySelect.value];
today=data.filter(x=>areas.includes(x.area));

renderSummary();

partyList.innerHTML=today.map(p=>`
<div class="party ${p.status==="BLOCK"?"block":"active"}" onclick="showParty('${p.party}')">
${p.party}<br>‚Çπ${p.balance.toLocaleString()}
</div>`).join("");

}

function renderSummary(){

let collected=visits.reduce((a,b)=>a+b.amount,0);
let recoverable=today.reduce((a,b)=>a+b.reactivate,0)-collected;
let progress= totalStops ? (visits.length/totalStops)*100 : 0;

summary.innerHTML=`
üí∞ Collected ‚Çπ${collected.toLocaleString()}<br>
üéØ Remaining ‚Çπ${recoverable.toLocaleString()}<br>
üìä Route Progress ${progress.toFixed(0)}%
<div class="progressBar"><div class="progressFill" style="width:${progress}%"></div></div>
`;

}

function showParty(name){
let p=data.find(x=>x.party===name);

partyCard.innerHTML=`
<h3>${p.party}</h3>
Area: ${p.area}<br>
Status: ${p.status}<br>
Outstanding: ‚Çπ${p.balance}<br>
Credit: ${p.credit} days<br><br>

<a class="btn go" href="tel:${p.phone}">Call</a>
<a class="btn collect" href="https://wa.me/91${p.phone}">WhatsApp</a>
<a class="btn stop" href="https://www.google.com/maps?q=${p.lat},${p.lng}" target="_blank">Navigate</a>
`;
}

function startJourney(){
navigator.geolocation.getCurrentPosition(pos=>{
userLat=pos.coords.latitude;
userLng=pos.coords.longitude;

route=today.filter(p=>p.lat && p.lng);
totalStops=route.length;

drawMap();
nextVisit();

});
}

function drawMap(){

if(!userLat) return;

let geoStops=today.filter(p=>p.lat && p.lng);

let next = route.length ? route[0] : geoStops[0];

let pinList = geoStops.map(p=>`${p.lat},${p.lng}`).join("|");

let previewURL=
`https://www.google.com/maps?q=${next.lat},${next.lng}|${pinList}&z=13&output=embed`;

mapBox.innerHTML=`
<iframe src="${previewURL}"></iframe>
<div class="legend">
üìç All Parties | ‚≠ê Center = Next Visit
</div>
`;

}

function nextVisit(){

if(!route.length){
aiBox.innerHTML="‚úÖ Route Completed";
renderSummary();
return;
}

let p=route[0];

aiBox.innerHTML=`
<h3>${p.party}</h3>
‚Çπ${p.balance} || ${p.credit} days<br><br>

<button class="btn stop" onclick="startVisit()">STOP</button>
<button class="btn collect disabled" id="collectBtn" onclick="collect()">COLLECT</button>
<button class="btn go disabled" id="goBtn" onclick="endVisit()">GO</button>
`;

visitState={current:p,startTime:null,amount:0};

}

function startVisit(){
visitState.startTime=new Date();
collectBtn.classList.remove("disabled");
}

function collect(){
let amt=prompt("Enter collection amount");
visitState.amount=num(amt);
goBtn.classList.remove("disabled");
}

function endVisit(){

visits.push({party:visitState.current.party,amount:visitState.amount});

route.shift();

renderSummary();
drawMap();
nextVisit();

}

load();

</script>
</body>
</html>