<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA TODAY</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
*{box-sizing:border-box}
body{font-family:Inter,Arial;margin:0;background:#f8fafc;color:#0f172a}

/* HEADER */
.header{position:sticky;top:0;background:white;padding:10px 8px 6px;text-align:center;border-bottom:1px solid #e2e8f0;z-index:1000}
#tourArea{font-size:11px;color:#64748b}
.kpiBar{font-size:13px;font-weight:700;margin-top:2px}
.progressBox{background:#e2e8f0;height:4px;border-radius:10px;margin:5px auto 0;max-width:180px}
#progressBar{height:4px;border-radius:10px}

/* LAYOUT */
.container{padding:8px;max-width:1000px;margin:auto}
.dashboard-grid{display:grid;gap:8px}

/* CARDS */
.card{background:white;padding:10px;border-radius:12px;border:1px solid #e2e8f0}
.missionCard{background:#0f766e;color:white;text-align:center;padding:12px;border-radius:12px;font-size:15px;font-weight:700}

/* MICRO STATS */
.statGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px}
.statBox{background:#f1f5f9;padding:8px 4px;border-radius:8px;text-align:center}
.statBox b{font-size:13px;display:block}
.statBox span{font-size:10px;color:#64748b}

/* PARTY LIST */
.partyItem{background:white;padding:10px;border-radius:10px;margin-bottom:6px;font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center;border:1px solid #e2e8f0;cursor:pointer;transition:0.25s}
.partyItem.active{border-left:3px solid #22c55e}
.partyItem.block{border-left:3px solid #ef4444;background:#fff1f2}

/* PARTY DETAIL */
.blockCard{border:1px solid #ef4444;background:#fff1f2}
.unlockBox{background:#16a34a;color:white;padding:8px;border-radius:8px;margin:8px 0;text-align:center;font-size:13px;font-weight:700}
.payBox{background:#ef4444;color:white;padding:9px;border-radius:9px;margin:8px 0;text-align:center;font-size:13px;font-weight:700}
.recoveryBarBg{background:#e2e8f0;height:6px;border-radius:10px;margin-top:6px}
.recoveryBar{height:6px;background:#ef4444;border-radius:10px}
.card b{font-size:11px;color:#64748b}
</style>
</head>

<body>

<div class="header">
AARADHYA â€¢ <span id="tourArea"></span>
<div class="kpiBar" id="fyKPI"></div>
<div class="progressBox"><div id="progressBar"></div></div>
</div>

<div class="container">
<div class="dashboard-grid">

<div class="missionCard" id="smartRecovery"></div>

<div class="card">
<div id="reactivationSummary"></div>
</div>

<div class="card">
<b>Todayâ€™s Route</b>
<div id="todayCount"></div>
<ul id="todayParties"></ul>
</div>

<div class="card" id="partyCard" style="display:none;">
<div id="partyDetails"></div>
</div>

<div class="card">
<b>Credit Cycle > 45</b>
<div id="creditCount"></div>
<ul id="creditExceeded"></ul>
</div>

</div>
</div>

<script>
const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

let COL={},sheetData=[];
let visitIndex=-1;
let orderedTodayList=[];
let visitedParties=new Set();
let routeTarget=0,routeRecovered=0;
let firstVisitTime=null,lastVisitTime=null;
let delayRisk=false;

const routeDeadlineHour=18;
const routeDeadlineMinute=30;

const tourPlan={
Monday:["JURIA"],Tuesday:["GHESS"],Wednesday:["GAISILATE"],
Thursday:["JHARBANDH"],Friday:["PADAMPUR"],Saturday:["PAIKMAL","MANDOSIL"]
};

function cleanNumber(v){return Number(String(v||0).replace(/[^0-9.-]/g,""))||0;}
function normalize(t){return t.toLowerCase().replace(/[^a-z]/g,"");}

function loadData(){

visitedParties.clear();
routeRecovered=0;
firstVisitTime=null;
lastVisitTime=null;

const today=new Date().toLocaleDateString("en-US",{weekday:"long"});
const todayAreas=tourPlan[today]||[];
document.getElementById("tourArea").innerText=today+" â†’ "+todayAreas.join(", ");

Papa.parse(sheetURL+"&t="+Date.now(),{
download:true,header:true,skipEmptyLines:true,
complete:function(res){

sheetData=res.data;

const columns=Object.keys(sheetData[0]);
const col=n=>columns.find(c=>normalize(c).includes(n));

COL={
PARTY:col("party"),AREA:col("area"),STATUS:col("accountstatus"),
BUSINESS:col("business"),BALANCE:col("balance"),
COLLECTION_MTD:col("collectionscurrentmonth"),
CREDIT:col("avgcreditcycle"),
REACTIVATE:col("paymentneededtoreactivate")
};

let fyBusiness=0,fyBalance=0,tourBalance=0;
let blockCount=0,totalReactivate=0,unlockBusiness=0;

let todayList=[],creditList=[];

sheetData.forEach(r=>{
let status=(r[COL.STATUS]||"").toUpperCase();

fyBusiness+=cleanNumber(r[COL.BUSINESS]);
fyBalance+=cleanNumber(r[COL.BALANCE]);

if(todayAreas.includes((r[COL.AREA]||"").toUpperCase())){

let bal=cleanNumber(r[COL.BALANCE]);
tourBalance+=bal;

todayList.push({name:r[COL.PARTY],balance:bal,status});

if(cleanNumber(r[COL.CREDIT])>45){
creditList.push({name:r[COL.PARTY],credit:r[COL.CREDIT]});
}

if(status==="BLOCK"){
blockCount++;
totalReactivate+=cleanNumber(r[COL.REACTIVATE]);
unlockBusiness+=cleanNumber(r[COL.BUSINESS]);
}
}
});

routeTarget=Math.round(tourBalance*0.30);

let fyCollection=fyBusiness-fyBalance;
let percent=(fyCollection/fyBusiness)*100;

document.getElementById("fyKPI").innerHTML=
`â‚¹${Math.round(fyBusiness).toLocaleString()} | â‚¹${Math.round(fyCollection).toLocaleString()} | ${percent.toFixed(0)}%`;

let bar=document.getElementById("progressBar");
bar.style.width=percent+"%";
bar.style.background=percent<40?"#ef4444":percent<70?"#f97316":"#22c55e";

orderedTodayList=[...todayList].sort((a,b)=>{
if(a.status==="BLOCK"&&b.status!=="BLOCK")return-1;
if(a.status!=="BLOCK"&&b.status==="BLOCK")return 1;
return b.balance-a.balance;
});

document.getElementById("todayCount").innerText=`${orderedTodayList.length} Parties`;

document.getElementById("todayParties").innerHTML=
orderedTodayList.map((p,i)=>`
<li id="partyRow${i}" class="partyItem ${p.status==="ACTIVE"?"active":p.status==="BLOCK"?"block":""}"
onclick="showParty('${p.name}',${i})">
${p.name}<span>â‚¹${p.balance.toLocaleString()}</span>
</li>`).join("");

document.getElementById("creditCount").innerText=`${creditList.length}`;

document.getElementById("creditExceeded").innerHTML=
creditList.map(c=>`<li class="partyItem">${c.name}<span>${c.credit}d</span></li>`).join("");

updateRouteTracker();
}});
}

function showParty(name,index){

visitIndex=index;

let party=sheetData.find(r=>r[COL.PARTY]===name);
if(!party)return;

let now=new Date();
if(!firstVisitTime)firstVisitTime=now;
lastVisitTime=now;

visitedParties.add(name);
routeRecovered+=cleanNumber(party[COL.COLLECTION_MTD]);

let status=(party[COL.STATUS]||"").toUpperCase();
let isBlock=status==="BLOCK";

let balance=cleanNumber(party[COL.BALANCE]);
let target=cleanNumber(party[COL.REACTIVATE]);
let recovered=cleanNumber(party[COL.COLLECTION_MTD]);
let remaining=target-recovered;
if(remaining<0)remaining=0;
let progress=target?((recovered/target)*100):0;

let card=document.getElementById("partyCard");
card.style.display="block";
card.classList.toggle("blockCard",isBlock);

document.getElementById("partyDetails").innerHTML=`
<b>${name}</b><br>${party[COL.AREA]}<br><br>
${isBlock?`
<div class="unlockBox">Unlock â‚¹${balance.toLocaleString()}</div>
<div class="payBox">Pay â‚¹${remaining.toLocaleString()}</div>
<div class="recoveryBarBg"><div class="recoveryBar" style="width:${progress}%"></div></div>
<div>${progress.toFixed(0)}%</div>`:""}
Bal â‚¹${balance.toLocaleString()} | MTD â‚¹${recovered.toLocaleString()}
`;

markVisitedAndFocusNext();
updateRouteTracker();
}

function markVisitedAndFocusNext(){
let currentRow=document.getElementById("partyRow"+visitIndex);
if(currentRow){currentRow.style.opacity="0.4";currentRow.style.textDecoration="line-through";}
let nextIndex=visitIndex+1;
if(nextIndex<orderedTodayList.length){
let nextRow=document.getElementById("partyRow"+nextIndex);
nextRow.scrollIntoView({behavior:"smooth",block:"center"});
nextRow.style.background="#fef9c3";
setTimeout(()=>{nextRow.style.background="";},1200);
visitIndex=nextIndex;
}
}

function getAntiDelaySuggestions(){
if(!delayRisk)return"";
let remaining=orderedTodayList.filter(p=>!visitedParties.has(p.name));
let sorted=remaining.sort((a,b)=>{
if(a.status==="BLOCK"&&b.status!=="BLOCK")return-1;
if(a.status!=="BLOCK"&&b.status==="BLOCK")return 1;
return b.balance-a.balance;
});
let top3=sorted.slice(0,3);
if(!top3.length)return"";
return `<br>âš¡ Visit next:<br>${top3.map(p=>"â€¢ "+p.name).join("<br>")}`;
}

function updateRouteTracker(){

let total=orderedTodayList.length;
let done=visitedParties.size;
let percent=total?Math.round((done/total)*100):0;

let finishText="â± Calculating paceâ€¦";
let warningText="";

if(done>1){

let avgTime=(lastVisitTime-firstVisitTime)/(done-1);
let remainingVisits=total-done;
let finishTime=new Date(Date.now()+(remainingVisits*avgTime));

finishText="â± Finish by: "+finishTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

let deadline=new Date();
deadline.setHours(routeDeadlineHour,routeDeadlineMinute,0,0);

if(finishTime>deadline){
warningText="ðŸš¨ Route delay risk";
delayRisk=true;
}else{
delayRisk=false;
let fastTrack=new Date();
fastTrack.setHours(17,30,0,0);
warningText=finishTime<fastTrack?"ðŸ”¥ Add extra recovery visits":"âœ… On track";
}
}

document.getElementById("smartRecovery").innerHTML=`
TODAY<br>
Collect â‚¹${routeTarget.toLocaleString()}<br>
Recovery â‚¹${Math.round(routeRecovered).toLocaleString()}<br><br>
Route: ${done}/${total} â€¢ ${percent}%<br>
${finishText}<br>
${warningText}
${getAntiDelaySuggestions()}
`;
}

loadData();
setInterval(loadData,120000);
</script>
</body>
</html>