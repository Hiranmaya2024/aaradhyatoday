<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA SMART TOUR</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.header{background:#fff;padding:10px;text-align:center;font-weight:bold}
.main{display:flex;height:calc(100vh - 60px)}
.left{width:40%;overflow:auto;background:#fff;padding:8px}
.right{width:60%;padding:10px}
.card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
#map{height:300px;border-radius:10px}
.partyRow{border-bottom:1px solid #eee;padding:6px}
.bigBtn{width:100%;padding:16px;font-size:16px;border:none;border-radius:10px;color:#fff;margin-top:10px}
.start{background:#16a34a}
</style>
</head>

<body>

<div class="header">
SELECT DAY:
<select id="daySelect"></select>
</div>

<div class="main">

<div class="left">
<div class="card" id="partyList"></div>
</div>

<div class="right">
<div class="card" id="aiBox"></div>
<div id="map"></div>
</div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const num=v=>Number(String(v||"").replace(/[^0-9.-]/g,""))||0;

function getDistance(a,b,c,d){
if(!a||!b||!c||!d) return 0;
const R=6371;
const dLat=(c-a)*Math.PI/180;
const dLon=(d-b)*Math.PI/180;
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

const tourPlan={
MONDAY:["JURIA"],
TUESDAY:["GHESS"],
WEDNESDAY:["GAISILATE"],
THURSDAY:["JHARBANDH"],
FRIDAY:["PADAMPUR"],
SATURDAY:["PAIKMAL","MANDOSIL"]
};

let map=L.map('map').setView([20.9,83.4],11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userMarker,routeLine,startMarker;
let data=[],today=[];

navigator.geolocation.watchPosition(pos=>{
let lat=pos.coords.latitude;
let lng=pos.coords.longitude;

if(userMarker) map.removeLayer(userMarker);

userMarker=L.marker([lat,lng]).addTo(map)
.bindPopup("You are here");

map.setView([lat,lng]);

userLat=lat;
userLng=lng;

});

Object.keys(tourPlan).forEach(d=>daySelect.innerHTML+=`<option>${d}</option>`);

daySelect.value=new Date().toLocaleDateString("en-US",{weekday:"long"}).toUpperCase();
daySelect.onchange=render;

function load(){
Papa.parse(CSV,{
download:true,header:true,
complete:res=>{
data=res.data.map(r=>({
party:r.PARTY,
area:(r.AREA||"").toUpperCase(),
lat:num(r.LAT),
lng:num(r.LNG),
balance:num(r.BALANCE),
credit:num(r["AVG CREDIT CYCLE"])
}));
render();
}});
}

function render(){

let areas=tourPlan[daySelect.value];

today=data.filter(d=>areas.some(a=>d.area.includes(a)));

drawPartyList();
drawPartyPins();

}

function drawPartyList(){

partyList.innerHTML="<b>TODAY'S PARTIES</b><br>"+today.map(p=>`
<div class="partyRow">${p.party}<br>
â‚¹${p.balance} | ${p.credit} days
</div>`).join("");

}

function drawPartyPins(){

today.forEach(p=>{
L.circleMarker([p.lat,p.lng],{radius:6,color:"green"}).addTo(map);
});

}

function startTour(){

let route=[ [userLat,userLng] ];

let tempLat=userLat,tempLng=userLng;

let sorted=[...today];

while(sorted.length){

sorted.forEach(p=>p.dist=getDistance(tempLat,tempLng,p.lat,p.lng));

sorted.sort((a,b)=>a.dist-b.dist);

let next=sorted.shift();

route.push([next.lat,next.lng]);

tempLat=next.lat;
tempLng=next.lng;

}

route.push([userLat,userLng]);

if(routeLine) map.removeLayer(routeLine);

routeLine=L.polyline(route,{color:"blue"}).addTo(map);

startMarker=L.marker([userLat,userLng],{color:"black"}).addTo(map);

}

aiBox.innerHTML=`<button class="bigBtn start" onclick="startTour()">CREATE ROUTE MAP</button>`;

load();

</script>
</body>
</html>