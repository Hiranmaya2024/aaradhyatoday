<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA TODAY</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
*{box-sizing:border-box}
body{font-family:Arial;margin:0;background:#f3fbf9;}

.header{
position:sticky;top:0;z-index:1000;
background:linear-gradient(90deg,#1e8e7e,#2fa36b);
color:white;text-align:center;padding:12px;
}

button.refresh{
margin-top:6px;padding:6px 12px;border:none;border-radius:6px;
font-weight:bold;cursor:pointer;
}

.container{padding:12px;max-width:1400px;margin:auto;}
.dashboard-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));}

.card{background:white;padding:14px;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,0.08);}
.big{font-size:16px;font-weight:bold;color:#1e8e7e;line-height:1.6;}

ul{padding-left:18px;margin:0;max-height:260px;overflow:auto;}
li{cursor:pointer;margin-bottom:6px;}

.blockCard{border:2px solid #dc2626 !important;background:#fff1f2 !important;}
.blockHeader{color:#dc2626;font-weight:bold;}

.payBox{
background:#dc2626;color:white;padding:12px;border-radius:12px;
margin:12px 0;text-align:center;font-size:18px;font-weight:bold;
}

.unlockBox{
background:#16a34a;color:white;padding:10px;border-radius:10px;
margin:10px 0;text-align:center;font-weight:bold;
}

.reactivationBox{background:#fff;border:2px solid #dc2626;padding:12px;border-radius:12px;margin:12px 0;}
.reactivationBarBg{background:#ffe4e6;height:10px;border-radius:10px;margin-top:6px;}
.reactivationBar{height:10px;border-radius:10px;background:#dc2626;}
</style>
</head>

<body>

<div class="header">
<b>AARADHYA TODAY</b>
<div id="tourArea"></div>

<button class="refresh" onclick="loadData()">ðŸ”„ Refresh</button>
<div id="lastUpdated" style="font-size:12px;margin-top:4px;"></div>
</div>

<div class="container">
<div class="dashboard-grid">

<div class="card" id="partyCard" style="display:none;border:2px solid #1e8e7e;">
<b>ðŸ‘¤ Party Details</b>
<div id="partyDetails" class="big"></div>
</div>

<div class="card">
<b>ðŸ§­ Todayâ€™s Route Parties</b>
<ul id="todayParties"></ul>
</div>

</div>
</div>

<script>

const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

let COL={},sheetData=[];

function cleanNumber(val){return Number(String(val||0).replace(/[^0-9.-]/g,""))||0;}
function normalize(text){return text.toLowerCase().replace(/[^a-z]/g,"");}

function loadData(){

Papa.parse(sheetURL+"&t="+new Date().getTime(),{
download:true,header:true,skipEmptyLines:true,

complete:function(res){

if(!res.data.length) return;

sheetData=res.data;

const columns=Object.keys(sheetData[0]);
const col=n=>columns.find(c=>normalize(c).includes(n));

COL={
PARTY:col("party"),
AREA:col("area"),
STATUS:col("accountstatus"),
BUSINESS:col("business"),
BALANCE:col("balance"),
BUSINESS_MTD:col("businesscurrentmonth"),
COLLECTION_MTD:col("collectionscurrentmonth"),
REACTIVATE:col("paymentneededtoreactivate")
};

let todayList=[];

sheetData.forEach(row=>{
todayList.push({
name:row[COL.PARTY],
balance:cleanNumber(row[COL.BALANCE])
});
});

document.getElementById("todayParties").innerHTML=
todayList.map(p=>`
<li data-name="${p.name}" onclick="showParty(this.dataset.name)">
${p.name} â€“ â‚¹${p.balance.toLocaleString()}
</li>`).join("");

document.getElementById("lastUpdated").innerText=
"Last updated: "+new Date().toLocaleTimeString();

}});

}

function showParty(name){

const party=sheetData.find(r=>r[COL.PARTY]==name);
if(!party) return;

const isBlock=(party[COL.STATUS]||"").toUpperCase()==="BLOCK";

const card=document.getElementById("partyCard");
card.style.display="block";
card.classList.toggle("blockCard",isBlock);

let target=cleanNumber(party[COL.REACTIVATE]);
let recovered=cleanNumber(party[COL.COLLECTION_MTD]);
let remaining=target-recovered;
if(remaining<0)remaining=0;

let progress=target?(recovered/target)*100:0;
let unlockBusiness=cleanNumber(party[COL.BUSINESS]);

document.getElementById("partyDetails").innerHTML=`

<b class="${isBlock?'blockHeader':''}" style="font-size:18px">${name}</b><br><br>

Area: ${party[COL.AREA]}<br>
Status: ${party[COL.STATUS]}<br>

${isBlock?`<div class="unlockBox">ðŸ”“ Unlock Billing Potential: â‚¹${unlockBusiness.toLocaleString()}</div>`:""}

${isBlock?`<div class="payBox">ðŸ’° Pay â‚¹${remaining.toLocaleString()} to Unblock</div>`:""}

Balance: â‚¹${cleanNumber(party[COL.BALANCE]).toLocaleString()}<br>
MTD Collection: â‚¹${recovered.toLocaleString()}

${isBlock?`
<div class="reactivationBox">
Progress
<div class="reactivationBarBg">
<div class="reactivationBar" style="width:${progress}%"></div>
</div>
${progress.toFixed(0)}%
</div>`:""}
`;

}

loadData();
setInterval(loadData,120000);

</script>

</body>
</html>