<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA SMART TOUR</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.header{background:#fff;padding:10px;text-align:center;border-bottom:1px solid #ddd}
.main{display:flex;height:calc(100vh - 110px)}
.left{width:40%;overflow:auto;background:#fff}
.right{width:60%;padding:10px}
.card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
#map{height:260px;border-radius:10px}
.btnMode{padding:6px 10px;border-radius:6px;border:none;margin-left:5px}
.activeMode{background:#16a34a;color:#fff}
</style>
</head>

<body>

<div class="header">

<b>Select Day:</b>
<select id="daySelect"></select>

<br><br>

Mode:
<button class="btnMode activeMode" id="liveBtn" onclick="setMode('live')">LIVE</button>
<button class="btnMode" id="testBtn" onclick="setMode('test')">TEST</button>

<div id="areaInfo"></div>

</div>

<div class="main">

<div class="left">
<div class="card" id="summary"></div>
<div id="partyList"></div>
</div>

<div class="right">
<div class="card" id="aiBox"></div>
<div id="map"></div>
<div class="card" id="partyCard"></div>
</div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

let MODE="live";

function setMode(m){
MODE=m;

liveBtn.classList.remove("activeMode");
testBtn.classList.remove("activeMode");

if(m==="live") liveBtn.classList.add("activeMode");
else testBtn.classList.add("activeMode");

render();
}

const tourPlan={
MONDAY:["JURIA"],
TUESDAY:["GHESS"],
WEDNESDAY:["GAISILATE"],
THURSDAY:["JHARBANDH"],
FRIDAY:["PADAMPUR"],
SATURDAY:["PAIKMAL","MANDOSIL"]
};

let map=L.map('map').setView([20.9,83.4],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let data=[],today=[],visits=[],markers=[];
let userLat=20.9,userLng=83.4;

Object.keys(tourPlan).forEach(d=>{
daySelect.innerHTML+=`<option value="${d}">${d}</option>`;
});

daySelect.value=new Date().toLocaleDateString("en-US",{weekday:"long"}).toUpperCase();
daySelect.onchange=render;

function load(){
Papa.parse(CSV,{
download:true,header:true,
complete:res=>{
data=res.data.map(r=>({
party:r.PARTY,
area:r.AREA.toUpperCase(),
status:r["ACCOUNT STATUS"],
balance:Number(r.BALANCE)||0,
credit:Number(r["AVG CREDIT CYCLE"])||0,
lat:parseFloat(r.LAT),
lng:parseFloat(r.LNG)
}));
render();
}});
}

function resetRoute(){

visits=[];
markers.forEach(m=>map.removeLayer(m));
markers=[];

userLat=20.9;
userLng=83.4;
}

function render(){

resetRoute();

let areas=tourPlan[daySelect.value];

areaInfo.innerHTML="Areas ‚Üí "+areas.join(", ");

today=data.filter(d=>areas.some(a=>d.area.includes(a)));

partyList.innerHTML=today.map(p=>`
<div onclick="showParty('${p.party}')">${p.party}</div>`).join("");

drawMap();
nextVisit();
}

function drawMap(){

let bounds=[];

today.forEach(p=>{
if(isNaN(p.lat))return;

let marker=L.circleMarker([p.lat,p.lng],{radius:8}).addTo(map);
markers.push(marker);
bounds.push([p.lat,p.lng]);
});

if(bounds.length)map.fitBounds(bounds);
}

function nextVisit(){

let pending=today.filter(p=>!visits.find(v=>v.party===p.party));

if(!pending.length){
aiBox.innerHTML="üèÅ Route completed";
return;
}

let p=pending[0];

aiBox.innerHTML=`
<h3>${p.party}</h3>
<button onclick="startVisit()">STOP</button>
<button onclick="collect()">COLLECT</button>
<button onclick="endVisit()">GO</button>
`;

visitState={current:p};
}

function startVisit(){}
function collect(){visitState.amount=prompt("Amount")}
function endVisit(){

visits.push({party:visitState.current.party});

nextVisit();
}

function showParty(name){
let p=data.find(x=>x.party===name);
partyCard.innerHTML=p.party;
}

load();

</script>
</body>
</html>