<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>

body{margin:0;font-family:Arial;background:#f1f5f9}

.panel{
padding:12px;
background:#fff;
box-shadow:0 2px 6px rgba(0,0,0,0.15);
}

#map{height:60vh}

select,button{
width:100%;
padding:14px;
margin-top:8px;
border-radius:10px;
border:none;
font-size:16px;
font-weight:bold;
}

.start{background:#16a34a;color:#fff}

</style>
</head>

<body>

<div class="panel" id="panel"></div>
<div id="map"></div>

<script>

const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
MONDAY:["JURIA"],
TUESDAY:["GHESS"],
WEDNESDAY:["GAISILATE"],
THURSDAY:["JHARBANDH"],
FRIDAY:["PADAMPUR"],
SATURDAY:["PAIKMAL","MANDOSIL"]
};

let map=L.map('map').setView([20.9,83.4],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let data=[],today=[],partyMarkers=[];

const num=v=>Number(String(v||"").replace(/[^0-9.-]/g,""))||0;

function setPanel(msg){
panel.innerHTML=`
<select id="daySel" onchange="renderDay(this.value)">
${Object.keys(tourPlan).map(d=>`<option>${d}</option>`)}
</select>
<div>${msg}</div>
<div id="count"></div>
`;
}

setPanel("üì° App started");

function plotPins(){

partyMarkers.forEach(m=>map.removeLayer(m));
partyMarkers=[];

let bounds=[];

today.forEach(p=>{
if(p.lat && p.lng){
let m=L.circleMarker([p.lat,p.lng],{radius:6,color:"green"}).addTo(map);
partyMarkers.push(m);
bounds.push([p.lat,p.lng]);
}
});

if(bounds.length) map.fitBounds(bounds,{padding:[40,40]});

document.getElementById("count").innerHTML="üè™ "+today.length+" parties";

}

function renderDay(day){

today=data.filter(d=>tourPlan[day].some(a=>d.area.includes(a)));

plotPins();

}

async function loadCSV(){

setPanel("‚è≥ Fetching data‚Ä¶");

try{

const response=await fetch(CSV_URL);

const csvText=await response.text();

const parsed=Papa.parse(csvText,{header:true});

data=parsed.data.map(r=>({

party:r.PARTY,

area:(r.AREA||"").toUpperCase(),

lat:num(r.LAT),

lng:num(r.LNG)

})).filter(x=>x.party);

setPanel("‚úÖ Data loaded");

renderDay("MONDAY");

}catch(err){

setPanel("‚ùå Data load failed");

}

}

loadCSV();

</script>
</body>
</html>
