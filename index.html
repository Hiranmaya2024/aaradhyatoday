<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f1f5f9}
.panel{padding:12px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.15)}
#map{height:58vh}
select,button{
width:100%;padding:14px;margin-top:8px;border:none;border-radius:10px;
font-size:15px;font-weight:bold}
.mainBtn{background:#16a34a;color:#fff}
.kpi{font-size:13px}
hr{margin:8px 0}
</style>
</head>

<body>

<div class="panel" id="panel"></div>
<div id="map"></div>

<script>

const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const SPEED=50;

const tourPlan={
MONDAY:["JURIA"],
TUESDAY:["GHESS"],
WEDNESDAY:["GAISILATE"],
THURSDAY:["JHARBANDH"],
FRIDAY:["PADAMPUR"],
SATURDAY:["PAIKMAL","MANDOSIL"]
};

let map=L.map('map').setView([20.9,83.4],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userLat=20.9,userLng=83.4,startLat,startLng,userMarker;

let data=[],today=[],pending=[],visited=[];
let routeLine,partyMarkers=[];

let fyBusiness=0,fyCollection=0;

let journeyStart,visitStart,currentParty,expense=0,stage="idle";

const num=v=>Number(String(v||"").replace(/[^0-9.-]/g,""))||0;

function getDistance(a,b,c,d){
if(!a||!b||!c||!d)return 0;
const R=6371;
const dLat=(c-a)*Math.PI/180;
const dLon=(d-b)*Math.PI/180;
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

navigator.geolocation.watchPosition(pos=>{
userLat=pos.coords.latitude;
userLng=pos.coords.longitude;
if(userMarker) map.removeLayer(userMarker);
userMarker=L.marker([userLat,userLng]).addTo(map);
});

async function loadCSV(){

setPanel("‚è≥ Loading data...");

const res=await fetch(CSV_URL);
const text=await res.text();

const parsed=Papa.parse(text,{header:true});

fyBusiness=0;fyCollection=0;

data=parsed.data.map(r=>{

let business=num(r.BUSINESS);
let balance=num(r.BALANCE);

fyBusiness+=business;
fyCollection+=(business-balance);

return{
party:r.PARTY,
area:(r.AREA||"").toUpperCase(),
lat:num(r.LAT),
lng:num(r.LNG),
balance:balance,
credit:num(r["AVG CREDIT CYCLE"]),
status:(r["ACCOUNT STATUS"]||"").toUpperCase(),
reactivation:num(r["PAYMENT NEEDED TO REACTIVATE"]),
business:business
};

}).filter(x=>x.party);

renderDay("MONDAY");

}

function progressColor(p){
if(p<40) return "red";
if(p<70) return "orange";
return "green";
}

function buildKPI(){

let blocked=today.filter(p=>p.status==="BLOCKED");

let unlock=blocked.reduce((a,b)=>a+b.balance,0);
let target=blocked.reduce((a,b)=>a+b.reactivation,0);

let percent=(fyCollection/fyBusiness*100)||0;

let creditList=[...today]
.filter(p=>p.credit>45)
.sort((a,b)=>b.credit-a.credit)
.slice(0,5)
.map(p=>`${p.party} (${p.credit})`).join("<br>");

return `
<div class="kpi">
<b>FY KPI</b><br>
‚Çπ${fyBusiness.toFixed(0)} ‚Üí ‚Çπ${fyCollection.toFixed(0)}
<div style="background:#ddd;height:6px;border-radius:4px;margin:4px 0">
<div style="width:${percent}%;height:6px;background:${progressColor(percent)}"></div>
</div>
<hr>
<b>Mission</b><br>
Collect ‚Çπ${target.toFixed(0)} ‚Üí Unlock ‚Çπ${unlock.toFixed(0)}
<hr>
<b>Credit >45</b><br>${creditList}
</div>
`;
}

function setPanel(html){
panel.innerHTML=`
<select onchange="renderDay(this.value)">
${Object.keys(tourPlan).map(d=>`<option>${d}</option>`)}
</select>
${buildKPI()}
${html}`;
}

function drawPins(){

partyMarkers.forEach(m=>map.removeLayer(m));
partyMarkers=[];

today.forEach(p=>{
if(p.lat&&p.lng){
partyMarkers.push(L.circleMarker([p.lat,p.lng],{radius:6,color:"green"}).addTo(map));
}
});

}

function renderDay(day){

today=data.filter(d=>tourPlan[day].some(a=>d.area.includes(a)));

pending=[...today];
visited=[];

drawPins();

setPanel(`<b>${day}</b><br>üè™ ${today.length}
<button class="mainBtn" onclick="startTour()">START TOUR</button>`);

}

function startTour(){
startLat=userLat;
startLng=userLng;
journeyStart=new Date();
updateNext();
}

function drawRoute(){

if(routeLine) map.removeLayer(routeLine);
if(!pending.length) return;

let lat=userLat,lng=userLng;
let temp=[...pending];
let coords=[[lat,lng]];

while(temp.length){
temp.forEach(p=>p.d=getDistance(lat,lng,p.lat,p.lng));
temp.sort((a,b)=>a.d-b.d);
let n=temp.shift();
coords.push([n.lat,n.lng]);
lat=n.lat;lng=n.lng;
}

routeLine=L.polyline(coords,{color:"blue",weight:4}).addTo(map);
map.fitBounds(routeLine.getBounds(),{padding:[40,40]});

}

function updateNext(){

if(!pending.length){returnToStart();return;}

pending.forEach(p=>p.dist=getDistance(userLat,userLng,p.lat,p.lng));
pending.sort((a,b)=>a.dist-b.dist);

currentParty=pending[0];

drawRoute();

setPanel(`
<b>${currentParty.party}</b><br>
‚Çπ${currentParty.balance} | ${currentParty.credit} days<br>
üìç ${currentParty.dist.toFixed(2)} km
<button class="mainBtn" onclick="workflow()">${getBtnText()}</button>
`);

}

function getBtnText(){
if(stage==="idle") return "START VISIT";
if(stage==="start") return "ENTER COLLECTION";
if(stage==="collect") return "COMPLETE VISIT";
}

function workflow(){

if(stage==="idle"){visitStart=new Date();stage="start";updateNext();return;}

if(stage==="start"){currentParty.amount=num(prompt("Enter collection"));stage="collect";updateNext();return;}

if(stage==="collect"){

let d=getDistance(userLat,userLng,currentParty.lat,currentParty.lng);

visited.push({...currentParty,distance:d,time:(new Date()-visitStart)/1000});

pending.shift();

userLat=currentParty.lat;
userLng=currentParty.lng;

stage="idle";

updateNext();
}
}

function returnToStart(){

if(routeLine) map.removeLayer(routeLine);

routeLine=L.polyline([[userLat,userLng],[startLat,startLng]],{
color:"red",weight:4,dashArray:"6,6"
}).addTo(map);

map.fitBounds(routeLine.getBounds(),{padding:[40,40]});

setPanel(`<button class="mainBtn" onclick="saveExpense()">ENTER TOUR EXPENSE</button>`);
}

function saveExpense(){expense=num(prompt("Expense"));endTour();}

function endTour(){

let totalCollection=visited.reduce((a,b)=>a+(b.amount||0),0);
let totalDistance=visited.reduce((a,b)=>a+b.distance,0);
let totalTime=(new Date()-journeyStart)/3600000;

let summary=`
Distance: ${totalDistance.toFixed(2)} km
Collection: ‚Çπ${totalCollection}
Expense: ‚Çπ${expense}
Net: ‚Çπ${totalCollection-expense}
Recovery/km: ‚Çπ${(totalCollection/totalDistance||0).toFixed(0)}
`;

setPanel(`<pre>${summary}</pre>
<button onclick="window.open('https://wa.me/?text='+encodeURIComponent(summary))">üìÑ SHARE WHATSAPP</button>`);
}

loadCSV();

</script>
</body>
</html>