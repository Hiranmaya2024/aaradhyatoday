<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>AARADHYA TODAY</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>

body{font-family:Arial;margin:0;background:#f1f5f9}
.main{display:flex;height:100vh}
.left{width:40%;overflow:auto;background:#fff}
.right{width:60%;padding:10px}
.card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
#map{height:260px;border-radius:10px}

.party{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.block{border-left:4px solid red}
.active{border-left:4px solid green}

</style>
</head>

<body>

<div class="main">

<div class="left">
<div class="card" id="summary"></div>
<div id="partyList"></div>
</div>

<div class="right">

<div class="card" id="aiBox">Start journey</div>
<div id="map"></div>
<div class="card" id="partyCard"></div>

</div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

let map = L.map('map').setView([20.9,83.4], 10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let data=[],today=[],route=[],visits=[];

const num=v=>Number(String(v||0).replace(/[^0-9.-]/g,""))||0;

function load(){

Papa.parse(CSV,{
download:true,
header:true,
skipEmptyLines:true,
complete:res=>{

data=res.data.map(r=>({
party:r["PARTY"],
area:r["AREA"],
status:r["ACCOUNT STATUS"],
balance:num(r["BALANCE"]),
credit:num(r["AVG CREDIT CYCLE"]),
lat:Number(r["LAT"]),
lng:Number(r["LNG"])
}));

render();

}

});

}

function render(){

today=data;

partyList.innerHTML=today.map(p=>`
<div class="party ${p.status==="BLOCK"?"block":"active"}"
onclick="showParty('${p.party}')">
${p.party}
</div>`).join("");

drawMap();

}

function getColor(p){

if(visits.find(v=>v.party===p.party)) return "grey";
if(route.length && route[0].party===p.party) return "gold";
if(p.status==="BLOCK") return "red";
return "green";

}

function drawMap(){

map.eachLayer(layer=>{
if(layer instanceof L.Marker) map.removeLayer(layer);
});

today.forEach(p=>{

if(!p.lat) return;

let marker = L.circleMarker([p.lat,p.lng],{
radius:8,
color:getColor(p),
fillOpacity:0.9
}).addTo(map);

marker.on("click",()=>showParty(p.party));

});

}

function showParty(name){

let p=data.find(x=>x.party===name);

partyCard.innerHTML=`
<h3>${p.party}</h3>
Outstanding â‚¹${p.balance}<br>
Credit ${p.credit} days
`;

}

load();

</script>
</body>
</html>