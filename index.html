<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AARADHYA TODAY</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f8fafc}
.header{position:sticky;top:0;background:#fff;padding:10px;border-bottom:1px solid #ddd;text-align:center}
.card{background:#fff;margin:8px;padding:10px;border-radius:10px;border:1px solid #e2e8f0}
.partyItem{padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;cursor:pointer}
.partyItem.block{border-left:4px solid red;background:#fff1f2}
.partyItem.active{border-left:4px solid green}
.visited{opacity:0.4;text-decoration:line-through}
.missionCard{background:#0f766e;color:#fff;text-align:center;font-weight:bold}
</style>
</head>

<body>

<div class="header">
AARADHYA TODAY
<div id="kpi"></div>
</div>

<div class="card missionCard" id="mission"></div>

<div class="card">
<b>Today Route</b>
<div id="count"></div>
<div id="list"></div>
</div>

<div class="card" id="details" style="display:none"></div>

<script>

const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

let data=[];
let visited=new Set();
let routeRecovered=0;
let routeTarget=0;
let firstVisit=null;
let lastVisit=null;

const deadlineHour=18;
const deadlineMinute=30;

function clean(v){return Number(String(v||0).replace(/[^0-9.-]/g,""))||0;}

function loadData(){

Papa.parse(sheetURL,{
download:true,header:true,skipEmptyLines:true,
complete:function(res){

data=res.data;

let fyBusiness=0,fyBalance=0,tourBalance=0;
let todayList=[];

data.forEach(r=>{

fyBusiness+=clean(r["BUSINESS"]);
fyBalance+=clean(r["BALANCE"]);

todayList.push({
name:r["PARTY"],
balance:clean(r["BALANCE"]),
status:(r["ACCOUNT STATUS"]||"").toUpperCase(),
collection:clean(r["Collections Current Month"])
});

tourBalance+=clean(r["BALANCE"]);

});

routeTarget=Math.round(tourBalance*0.3);

document.getElementById("kpi").innerHTML=
"FY Collection â‚¹"+(fyBusiness-fyBalance).toLocaleString();

renderList(todayList);
updateMission(todayList.length);

}
});
}

function renderList(list){

list.sort((a,b)=>{
if(a.status==="BLOCK"&&b.status!=="BLOCK")return-1;
if(a.status!=="BLOCK"&&b.status==="BLOCK")return 1;
return b.balance-a.balance;
});

document.getElementById("count").innerText=list.length+" Parties";

document.getElementById("list").innerHTML=
list.map((p,i)=>`
<div id="row_${i}"
class="partyItem ${p.status==="BLOCK"?"block":"active"}"
onclick="visit('${p.name}',${p.collection},${i})">
${p.name}
<span>â‚¹${p.balance.toLocaleString()}</span>
</div>
`).join("");
}

function visit(name,collection,index){

if(!firstVisit)firstVisit=new Date();
lastVisit=new Date();

visited.add(name);
routeRecovered+=collection;

let row=document.getElementById("row_"+index);
row.classList.add("visited");

showDetails(name);

autoFocusNext(index);

updateMission(data.length);
}

function autoFocusNext(index){

let next=document.getElementById("row_"+(index+1));

if(next){
next.scrollIntoView({behavior:"smooth",block:"center"});
next.style.background="#fef9c3";

setTimeout(()=>next.style.background="",1000);
}
}

function showDetails(name){

let p=data.find(x=>x["PARTY"]===name);

document.getElementById("details").style.display="block";
document.getElementById("details").innerHTML=
"<b>"+name+"</b><br>Balance â‚¹"+clean(p["BALANCE"]).toLocaleString();
}

function updateMission(total){

let done=visited.size;
let percent=Math.round(done/total*100);

let finishText="â± Calculatingâ€¦";
let statusText="";

if(done>1){

let avg=(lastVisit-firstVisit)/(done-1);
let remain=total-done;

let finishTime=new Date(Date.now()+remain*avg);

finishText="â± Finish by "+finishTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

let deadline=new Date();
deadline.setHours(deadlineHour,deadlineMinute,0,0);

if(finishTime>deadline){
statusText="ðŸš¨ Delay risk";
}else{
let fastTrack=new Date();
fastTrack.setHours(17,30,0,0);
statusText=finishTime<fastTrack?"ðŸ”¥ Fast pace":"âœ… On track";
}
}

document.getElementById("mission").innerHTML=
"Target â‚¹"+routeTarget.toLocaleString()+"<br>"+
"Done â‚¹"+routeRecovered.toLocaleString()+"<br>"+
"Route "+done+"/"+total+" â€¢ "+percent+"%<br>"+
finishText+"<br>"+statusText;
}

loadData();

</script>
</body>
</html>