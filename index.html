<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AAradhya Tour</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>

body{font-family:Poppins;margin:0;background:#f4f6f9}

.header{background:#0d6efd;color:#fff;padding:14px;font-weight:600}

/* TOP ROUTE BOX */

.routeBox{
background:#fff;
margin:10px;
padding:14px;
border-radius:14px;
display:grid;
grid-template-columns:1fr 1fr;
gap:10px;
box-shadow:0 2px 10px rgba(0,0,0,0.08)
}

.routeStats{font-size:15px;line-height:1.8}

.partyList{
max-height:140px;
overflow:auto;
font-size:13px
}

/* CUSTOMER GRID */

.grid{
padding:10px;
display:grid;
gap:12px
}

.customer{
background:#fff;
padding:14px;
border-radius:12px;
box-shadow:0 2px 6px rgba(0,0,0,0.08);
font-size:14px
}

@media(min-width:600px){.grid{grid-template-columns:1fr 1fr}}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr 1fr}}
@media(min-width:1200px){.grid{grid-template-columns:1fr 1fr 1fr 1fr}}

</style>
</head>

<body>

<div class="header">AAradhya Tour Dashboard</div>

<div id="routeBox" class="routeBox">Loading route‚Ä¶</div>

<div id="customerGrid" class="grid"></div>

<script>

const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

const tourPlan={
Monday:["Juria"],
Tuesday:["Ghess"],
Wednesday:["Gaisilate"],
Thursday:["Dava"],
Friday:["Padampur"],
Saturday:["Paikmal","Mandosil"]
}

let customers=[],todayRoute=[]
let userLat,userLng

const today=new Date().toLocaleDateString('en-US',{weekday:'long'})
const todayAreas=tourPlan[today]||[]

navigator.geolocation.getCurrentPosition(pos=>{
userLat=pos.coords.latitude
userLng=pos.coords.longitude
renderAll()
})

function parseCSV(text){
const rows=[];let row=[],value="",insideQuotes=false
for(let char of text){
if(char=='"'){insideQuotes=!insideQuotes;continue}
if(char==","&&!insideQuotes){row.push(value);value="";continue}
if((char=="\n"||char=="\r")&&!insideQuotes){
if(value||row.length){row.push(value);rows.push(row)}
row=[];value="";continue}
value+=char}
return rows
}

fetch(csvUrl)
.then(res=>res.text())
.then(text=>{

let rows=parseCSV(text).slice(1).filter(r=>r[0])

customers=rows.map(r=>({
name:r[0],
area:r[1],
due:parseFloat(r[6])||0,
lat:parseFloat(r[14]),
lng:parseFloat(r[15])
}))

customers.sort((a,b)=>b.due-a.due)

todayRoute=customers.filter(c=>todayAreas.includes(c.area))

renderAll()

})

function getDistance(a,b,c,d){
const R=6371
const dLat=(c-a)*Math.PI/180
const dLng=(d-b)*Math.PI/180
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*
Math.cos(c*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))
}

function calculateRoute(){

if(!userLat||todayRoute.length===0) return {dist:0,time:0}

let total=0
let prevLat=userLat
let prevLng=userLng

todayRoute.forEach(p=>{
if(p.lat){
total+=getDistance(prevLat,prevLng,p.lat,p.lng)
prevLat=p.lat
prevLng=p.lng
}
})

return {
dist:total.toFixed(1),
time:(total/25).toFixed(1)
}
}

function renderAll(){

if(customers.length===0) return

let route=calculateRoute()

routeBox.innerHTML=`

<div class="routeStats">
<b>üóì Today‚Äôs Route ‚Äì ${todayAreas.join(", ")}</b><br>
Parties: ${todayRoute.length}<br>
üìè ${route.dist} km<br>
‚è± ${route.time} hrs
</div>

<div class="partyList">
${todayRoute.map((c,i)=>`${i+1}. ${c.name}`).join("<br>")}
</div>
`

customerGrid.innerHTML=""

customers.forEach(c=>{
customerGrid.innerHTML+=`
<div class="customer">
<b>${c.name}</b><br>
${c.area}<br>
Balance: ‚Çπ${c.due}
</div>`
})

}

</script>

</body>
</html>