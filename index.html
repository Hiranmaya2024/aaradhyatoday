<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{margin:0;font-family:Arial}
#map{height:65vh}
.panel{padding:12px;background:#fff}
button,select{width:100%;padding:12px;margin-top:6px;font-size:15px}
.mainBtn{background:#16a34a;color:#fff;border:none;border-radius:8px}
</style>
</head>

<body>

<div class="panel" id="panel"></div>
<div id="map"></div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv";

const tourPlan={
MONDAY:["JURIA"],
TUESDAY:["GHESS"],
WEDNESDAY:["GAISILATE"],
THURSDAY:["JHARBANDH"],
FRIDAY:["PADAMPUR"],
SATURDAY:["PAIKMAL","MANDOSIL"]
};

let map=L.map("map").setView([20.9,83.4],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let livePos=[20.9,83.4];
let routePos=[20.9,83.4];

let data=[];
let today=[];

let visited=new Set();
let currentId=null;

let userMarker,routeLine;
let pins=[];

navigator.geolocation.watchPosition(pos=>{
livePos=[pos.coords.latitude,pos.coords.longitude];
if(userMarker) map.removeLayer(userMarker);
userMarker=L.circleMarker(livePos,{radius:8,color:"blue",fillColor:"blue",fillOpacity:1}).addTo(map);
});

function dist(a,b){
const R=6371;
let dLat=(b[0]-a[0])*Math.PI/180;
let dLon=(b[1]-a[1])*Math.PI/180;
let x=Math.sin(dLat/2)**2+
Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

async function load(){

panel.innerHTML="Loading data...";

const res=await fetch(CSV);
const text=await res.text();
const parsed=Papa.parse(text,{header:true});

data=parsed.data.map((r,i)=>({
id:i,
party:r.PARTY,
area:(r.AREA||"").toUpperCase(),
lat:parseFloat(r.LAT),
lng:parseFloat(r.LNG)
})).filter(x=>x.party);

renderDay("MONDAY");

}

function renderDay(day){

today=data.filter(d=>tourPlan[day].some(a=>d.area.includes(a)));

visited.clear();
currentId=null;

routePos=[...livePos];

draw();

panel.innerHTML=`
<select onchange="renderDay(this.value)">
${Object.keys(tourPlan).map(d=>`<option>${d}</option>`)}
</select>
<b>${day}</b><br>üè™ ${today.length}
<button class="mainBtn" onclick="start()">START TOUR</button>
`;

}

function draw(){

pins.forEach(p=>map.removeLayer(p));
pins=[];

today.forEach(p=>{
let color="gray";
if(visited.has(p.id)) color="green";
if(currentId===p.id) color="orange";

pins.push(
L.circleMarker([p.lat,p.lng],{radius:7,color:color,fillColor:color,fillOpacity:1}).addTo(map)
);
});

}

function buildRoute(){

let remaining=today.filter(p=>!visited.has(p.id));
let temp=[...remaining];

let pos=[...routePos];
let coords=[pos];

while(temp.length){

temp.sort((a,b)=>
dist(pos,[a.lat,a.lng]) - dist(pos,[b.lat,b.lng])
);

let next=temp.shift();
coords.push([next.lat,next.lng]);
pos=[next.lat,next.lng];

}

return coords;

}

function drawRoute(){

if(routeLine) map.removeLayer(routeLine);

let coords=buildRoute();

routeLine=L.polyline(coords,{color:"blue",weight:4}).addTo(map);

map.fitBounds(routeLine.getBounds(),{padding:[40,40]});

}

function start(){
goNext();
}

function goNext(){

let remaining=today.filter(p=>!visited.has(p.id));

if(!remaining.length){
finish();
return;
}

remaining.sort((a,b)=>
dist(routePos,[a.lat,a.lng]) - dist(routePos,[b.lat,b.lng])
);

let next=remaining[0];

currentId=next.id;

draw();
drawRoute();

panel.innerHTML+=`
<br><b>${next.party}</b>
<button class="mainBtn" onclick="visit()">VISIT DONE</button>
`;

}

function visit(){

let shop=today.find(p=>p.id===currentId);

visited.add(currentId);
routePos=[shop.lat,shop.lng];

currentId=null;

goNext();

}

function finish(){

if(routeLine) map.removeLayer(routeLine);

routeLine=L.polyline([routePos,livePos],{
color:"red",dashArray:"6,6",weight:4
}).addTo(map);

map.fitBounds(routeLine.getBounds(),{padding:[40,40]});

panel.innerHTML+="<br><b>Route Completed</b>";

}

load();

</script>
</body>
</html>